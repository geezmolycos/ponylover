<!doctype html>
<html>
    <head>
        <title>爱我的六色马可以做什么事</title>
        <meta charset="UTF-8">
	    <script
            src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
            crossorigin="anonymous"></script>
        <script src="./player-small.js"></script>
        <script src="./song.js"></script>
        <script type="text/javascript">
            function startMusic() {
              //----------------------------------------------------------------------------
              // Demo program section
              //----------------------------------------------------------------------------
            
              // Initialize music generation (player).
              var t0 = new Date();
              var player = new CPlayer();
              player.init(song);
            
              // Generate music...
              var done = false;
              let musicInterval = setInterval(function () {
                if (done) {
                    clearInterval(musicInterval);
                  return;
                }
            
                done = player.generate() >= 1;
            
                if (done) {
                  var t1 = new Date();
            
                  // Put the generated song in an Audio element.
                  var wave = player.createWave();
                  var audio = document.createElement("audio");
                  audio.src = URL.createObjectURL(new Blob([wave], {type: "audio/wav"}));
                  audio.loop = true;
                  audio.volume = 0.2;
                  audio.play();
                  window.bgm = audio;
                }
              }, 0);
            }
        </script>
        <style>
            :root {
                --game-grid-size: 34px;
                --game-grid-border: 2px;
            }

            .layer-cont{
                position: relative;
            }
            .sublayer-cont{
                position: absolute;
                left: 0px;
                top: 0px;
                line-height: 0;
            }
            .cell-wrapper{
                display: inline-block;
                width: var(--game-grid-size);
                height: var(--game-grid-size);
                box-sizing: border-box;
                padding-top: var(--game-grid-border);
                padding-left: var(--game-grid-border);
                image-rendering: pixelated;
            }
            .grid-cont{
                border-bottom: var(--game-grid-border) solid black;
                border-right: var(--game-grid-border) solid black;
                position: static;
                display: inline-block;
            }
            .grid-cont .cell-wrapper{
                border-top: var(--game-grid-border) solid black;
                border-left: var(--game-grid-border) solid black;
                padding-top: 0px;
                padding-left: 0px;
            }

            kbd {
                margin: 2px;
                padding: 2px;
                border: 1px solid gray;
                border-radius: 2px;
            }

            
.hue-rotate-animated {
  animation: filter-animation 2s infinite, spin 4s linear;
}

@keyframes filter-animation {
  0% {
    filter: hue-rotate(0deg);
    background-color: #1e5799;
  }
  
  50% {
    filter: hue-rotate(100deg);
    background-color: #7e1e99;
  }
  
  100% {
    filter: hue-rotate(0deg);
    background-color: #1e5799;
  }
}

@keyframes spin { 
    100% { 
        -webkit-transform: rotate(1080deg) scale(0.1); 
        transform:rotate(1080deg) scale(0.1); 
    } 
}
        </style>
        <style>
            /* main ui frame styles */

            #game-center {
                text-align: center;
            }

            #game-cont {
                border: 2px dashed black;
                padding: 12px;
                box-sizing: border-box;
                display: inline-block;
                text-align: initial;
            }

            #title-cont, #main-cont {
                display: block;
            }

            #title-cont {
                text-align: center;
                font-size: larger;
                margin: 12px;
            }

            #yard-cont, #op-cont, #handinfo-cont{
                display: inline-block;
                vertical-align: top;
            }

            #yard-cont {
                
            }

            #op-cont {
                width: calc(var(--game-grid-size) * 8 + var(--game-grid-border));
            }

            #handinfo-cont {
                width: calc(var(--game-grid-size) * 6 + var(--game-grid-border));
            }

            #crafting-cont {
                margin-top: calc(var(--game-grid-size) - var(--game-grid-border));
            }

            .ground-layer-cont,  .underground-layer-cont {
                position: absolute;
            }

            .ground-layer-cont .grid-cont{
                border-bottom: var(--game-grid-border) solid gray;
                border-right: var(--game-grid-border) solid gray;
            }
            .ground-layer-cont .grid-cont .cell-wrapper{
                border-top: var(--game-grid-border) solid gray;
                border-left: var(--game-grid-border) solid gray;
            }

            .grid-title {
                border-top: var(--game-grid-border) solid gray;
                border-left: var(--game-grid-border) solid gray;
                border-right: var(--game-grid-border) solid gray;
                text-align: center;
            }

            .underground-layer-cont .grid-cont{
                border-bottom: var(--game-grid-border) solid rgb(156, 90, 24);
                border-right: var(--game-grid-border) solid rgb(156, 90, 24);
            }
            .underground-layer-cont .grid-cont .cell-wrapper{
                border-top: var(--game-grid-border) solid rgb(156, 90, 24);
                border-left: var(--game-grid-border) solid rgb(156, 90, 24);
            }

            #hand-cont, .game-button {
                display: inline-block;
                vertical-align: bottom;
            }

            .game-button{
                display: inline-block;
                border: 2px solid black;
            }

            #main-cont {
                position: relative;
            }

            #control-cont {
                position: absolute;
                bottom: 0;
            }

            #hand-cont {
                position: relative;
            }

            .hand-main-indicator {
                position: absolute;
                display: block;
                left: 0;
                top: 0;
                width: calc(var(--game-grid-size) + var(--game-grid-border));
                height: calc(var(--game-grid-size) + var(--game-grid-border));
                box-sizing: border-box;
                border: 3px solid orange;
            }

            #info-cont{
                margin: 4px;
                font-size: small;
            }

            #yard-cont-inner{
                position: relative;
                width: calc(var(--game-grid-size) * 24 + var(--game-grid-border));
                height: calc(var(--game-grid-size) * 16 + var(--game-grid-border));
                /*overflow: hidden;*/
            }

            #yard-cont-inner .layer-cont {
                z-index: 0;
            }

            #yard-cont-inner .move-yard {
                z-index: 1;
            }

            .move-yard{
                position: absolute;
            }

            .move-left {
                left: 0;
                height: 100%;
                width: 12px;
            }

            .move-right {
                right: 0;
                height: 100%;
                width: 12px;
            }
            .move-top {
                top: 0;
                width: 100%;
                height: 12px;
            }

            .move-bottom {
                bottom: 0;
                width: 100%;
                height: 12px;
            }

            #dialog-cont {
                width: calc(100% - 16em);
                border: 1px solid black;
                margin-top: 1em;
                margin-left: 1em;
                font-size: large;
                padding: 5px;
                font-family: monospace;
                height: 4em;
                overflow: scroll;
                display: inline-block;
            }

            #dialog-image-cont {
                width: 4em;
                border: 1px solid black;
                margin-top: 1em;
                font-size: large;
                padding: 5px;
                font-family: monospace;
                height: 4em;
                overflow: scroll;
                display: inline-block;
                image-rendering: pixelated;
            }

            .dialog-role {
                font-weight: bold;
                margin-right: 5px;
            }

            table {
                margin: auto;
            }

            span.space {
                margin-right: 2em;
            }

        </style>
    </head>
    <body>
        <div id="game-center">
            <div id="game-cont">
                <div id="title-cont">···==···꒰ა ♡爱我的六色马可以做什么事♡ ໒꒱···==···</div>
                <div id="main-cont">
                    <div id="yard-cont">
                        <div class="grid-title">—— 地图 ——</div>
                        <div id="yard-cont-inner">
                            <div class="move-yard move-left" data-x="-1" data-y="0"></div>
                            <div class="move-yard move-right" data-x="1" data-y="0"></div>
                            <div class="move-yard move-top" data-x="0" data-y="-1"></div>
                            <div class="move-yard move-bottom" data-x="0" data-y="1"></div>
                        </div>
                    </div>
                    <div id="handinfo-cont">
                        <div id="hand-cont"><div class="grid-title">—— 物品栏 ——</div></div>
                        <div id="info-cont"></div>
                        <div id="control-cont"><button id="flip-yard" class="game-button">切换层</button>　　<button id="save" class="game-button">保存</button><button id="clear-save" class="game-button">重置</button><button id="turn-music" class="game-button">音乐</button></div>
                    </div>
                    <div id="op-cont">
                        <div id="state-selector-cont"><div class="grid-title">—— 物体设置 ——</div></div>
                        <div id="crafting-cont"><div class="grid-title">—— 合成 ——</div></div>
                        <div id="instructions">
                            操作说明：
                            <ul>
                                <li>按<kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd>或鼠标移动到边缘格子的边缘移动地图</li>
                                <li>按<kbd>1</kbd>~<kbd>5</kbd>交换手中（橙色格子）的物品和物品栏中的物品</li>
                                <li>按<kbd>I</kbd><kbd>J</kbd><kbd>K</kbd><kbd>L</kbd>旋转手中的物品</li>
                                <li>按"切换层"按钮在地表和地下两层间切换</li>
                                <li>左上的棕色网格区域是合成台，需要把物品运到那里合成</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div id="footer-cont"></div>
                <div ><div id="dialog-image-cont"></div><div id="dialog-cont"><br><br><br><br><br><br><br><br><br><br><br><br></div><button id="skip-dialog" class="game-button">跳过</button></div>
            </div>
            <div id="complete-cont" style="display: none;">
                <h1>你穿过了虫洞，来到了一片光芒之中。</h1>
                <h1>你如愿以偿到达了六色马的世界！</h1>
                <div>
                    <div id="complete-pony-cont" style="display: inline-block">
                        你的六色马：
                        <div id="six-color-text"></div>
                        <div id="six-color-color" style="width: 32px; height: 32px;"></div>
                        <img id="six-color" src="" alt="">
                    </div>
                    <div style="display: inline-block">
                        物品生产数量：
                        <div id="stats-cont" style="text-align: center;">
                        </div>
                        建筑合成数量：
                        <div id="entity-stats-cont" style="text-align: center;">
                        </div>
                    </div>
                </div>
            </div>
            <div id="prompt-container"></div>
            <style>
                .prompt {
                    position: fixed;
                    user-select: none;
                    font-size: small;
                    background-color: aliceblue;
                    pointer-events: none;
                }
            </style>
            <script>
                var mouse_x = null;
                var mouse_y = null;
                    
                document.addEventListener('mousemove', onMouseUpdate, false);
                document.addEventListener('mouseenter', onMouseUpdate, false);
                
                function onMouseUpdate(e) {
                    mouse_x = e.pageX;
                    mouse_y = e.pageY;
                }
                function show_prompt(text){
                    let new_prompt = $('<div>')
                        .addClass('prompt').append(text);
                    $('#prompt-container').append(new_prompt);
                    new_prompt.css('left', mouse_x - new_prompt.innerWidth() / 2 + 'px').css('top', mouse_y- new_prompt.innerHeight() / 2 + 'px').css('opaque', '1');
                    let f = ()=>{
                        new_prompt.css('top', parseFloat(new_prompt.css('top')) - 2 + 'px');
                        new_prompt.css('opacity', parseFloat(new_prompt.css('opacity')) - 0.1);
                        if (parseFloat(new_prompt.css('opacity')) > 0){
                            setTimeout(f, 100);
                        } else {
                            new_prompt.remove();
                        }
                    }
                    setTimeout(f, 100);
                }

            </script>
        </div>
        <div id="time-control-cont">
            <button id="advance">advance</button>
            <button id="stop">stop</button>
            <span id="time">0</span>
        </div>
        <script>
            'use strict'

            let global_debug = false;
            let debug_tooltip = global_debug;

            if (!global_debug){
                $('#time-control-cont').hide();
            }

            const cardinal = [[0, -1], [-1, 0], [1, 0], [0, 1]];

            class EmptyEnt{
                can_place_item_on(inst){return true;}
                can_be_moved(inst){return true;}
                tick(inst){}
                draw(inst){}
                info(inst){return '什么也没有';}
                enum_states(){
                    return [];
                }
                init_other_states(state){}
            }

            class WallEnt{
                can_place_item_on(inst){return false;}
                can_be_moved(inst){return false;}
                tick(inst){}
                draw(inst){
                        // return $('<div>')
                        //     .css('width', `100%`).css('height', '100%')
                        //     .css('background-color', `#ff0000`);
                }
                info(inst){return '这个地方已经被地上的物体占用，不能放机器';}
                enum_states(){
                    return [];
                }
                init_other_states(state){}
            }

            function entity_dir_source(inst){
                let [dx, dy] = cardinal[inst.state.dir];
                let [tx, ty] = [inst.x - dx, inst.y - dy];
                return [tx, ty];
            }
            function entity_dir_source_left(inst){
                let [dx, dy] = cardinal[inst.state.dir];
                let [tx, ty] = [inst.x + dy, inst.y - dx];
                return [tx, ty];
            }
            function entity_dir_source_right(inst){
                let [dx, dy] = cardinal[inst.state.dir];
                let [tx, ty] = [inst.x - dy, inst.y + dx];
                return [tx, ty];
            }

            function entity_dir_target(inst){
                let [dx, dy] = cardinal[inst.state.dir];
                let [tx, ty] = [inst.x + dx, inst.y + dy];
                return [tx, ty];
            }

            function entity_output_item(inst, tx, ty, item_type, item_state){
                if (item_type == item_table.get('empty')){
                    return true;
                }
                if (item_type == null){
                    return false;
                }
                if (inst.layer.item_sublayer.get_inst(tx, ty).type !== item_table.get('empty')
                    || inst.layer.get_item_changed(tx, ty)
                    || !inst.layer.can_place_item_on(tx, ty)){
                    return false;
                }
                inst.layer.next_item_sublayer.swap(tx, ty, item_type, item_state);
                inst.layer.set_item_changed(tx, ty, true);
                return true;
            }

            class BeltEnt extends EmptyEnt{
                constructor(delay){
                    super();
                    this.delay = delay;
                }
                can_place_item_on(inst){return true;}
                tick(inst){
                    if (inst.layer.time % this.delay != 0){
                        return;
                    }
                    //console.log(inst.x, inst.y);
                    if (inst.layer.item_sublayer.get_inst(inst.x, inst.y).type === item_table.get('empty')){
                        return;
                    }
                    let old_item_inst = inst.layer.item_sublayer.get_inst(inst.x, inst.y);
                    let [tx, ty] = entity_dir_target(inst);
                    if (entity_output_item(inst, tx, ty, old_item_inst.type, old_item_inst.state)){
                        inst.layer.next_item_sublayer.swap(inst.x, inst.y, item_table.get('empty'), null);
                        inst.layer.set_item_changed(inst.x, inst.y, true);
                    }
                }
                draw(inst){
                    let rotation = ['0deg', '270deg', '90deg', '180deg'][inst.state.dir];
                    return $('<div>')
                        .css('background-image', `url('${this.icon}')`)
                        .css('background-size', '512px 512px')
                        .css('width', '100%').css('height', '100%')
                        .css('transform', `rotate(${rotation})`)
                        .css('background-position', `-${this.pos_x * 32}px -${this.pos_y * 32}px`);
                }
                info(inst){return '传送带'}
                enum_states(){
                    return [
                        ['dir', [0,1,2,3]],
                    ];
                }
                init_other_states(state){}
            }

            class LadderEnt extends EmptyEnt{
                constructor(delay){
                    super();
                    this.delay = delay;
                }
                can_place_item_on(inst){return true;}
                tick(inst){
                    if (inst.layer.time % this.delay != 0){
                        return;
                    }
                    //console.log(inst.x, inst.y);
                    if (inst.layer.item_sublayer.get_inst(inst.x, inst.y).type === item_table.get('empty')){
                        return;
                    }
                    let old_item_inst = inst.layer.item_sublayer.get_inst(inst.x, inst.y);
                    let tx = inst.x;
                    let ty = inst.y;
                    if (inst.layer.ladder_layer.item_sublayer.get_inst(tx, ty).type !== item_table.get('empty')
                        || inst.layer.ladder_layer.get_item_changed(tx, ty)
                        || !inst.layer.ladder_layer.can_place_item_on(tx, ty)){
                        return;
                    }
                    inst.layer.ladder_layer.next_item_sublayer.swap(tx, ty, old_item_inst.type, old_item_inst.state);
                    inst.layer.ladder_layer.set_item_changed(tx, ty, true);
                    inst.layer.next_item_sublayer.swap(inst.x, inst.y, item_table.get('empty'), null);
                    inst.layer.set_item_changed(inst.x, inst.y, true);
                }
                draw(inst){
                    return $('<div>')
                        .css('background-image', `url('${this.icon}')`)
                        .css('background-size', '512px 512px')
                        .css('width', '100%').css('height', '100%')
                        .css('background-position', `-${this.pos_x * 32}px -${this.pos_y * 32}px`);
                }
                info(inst){}
                enum_states(){
                    return [];
                }
                init_other_states(state){}
            }

            class RouterEnt extends EmptyEnt{
                constructor(delay){
                    super();
                    this.delay = delay;
                }
                can_place_item_on(inst){return true;}
                tick(inst){
                    if (inst.layer.time % this.delay != 0){
                        return;
                    }
                    //console.log(inst.x, inst.y);
                    if (inst.layer.item_sublayer.get_inst(inst.x, inst.y).type === item_table.get('empty')){
                        return;
                    }
                    let tick_time = Math.floor(inst.layer.time / this.delay);
                    let leftup = tick_time % 6 === 0 || tick_time % 6 === 1 || tick_time % 6 === 4;
                    let old_item_inst = inst.layer.item_sublayer.get_inst(inst.x, inst.y);

                    let tx = inst.x;
                    let ty = inst.y;
                    if (inst.state.hv === 0){
                        tx += leftup ? -1 : 1;
                    } else {
                        ty += leftup ? -1 : 1;
                    }
                    if (entity_output_item(inst, tx, ty, old_item_inst.type, old_item_inst.state)){
                        inst.layer.next_item_sublayer.swap(inst.x, inst.y, item_table.get('empty'), null);
                        inst.layer.set_item_changed(inst.x, inst.y, true);
                    }
                }
                draw(inst){
                    let rotation = ['0deg', '90deg'][inst.state.hv];
                    return $('<div>')
                        .css('background-image', `url('${this.icon}')`)
                        .css('background-size', '512px 512px')
                        .css('width', '100%').css('height', '100%')
                        .css('transform', `rotate(${rotation})`)
                        .css('background-position', `-${this.pos_x * 32}px -${this.pos_y * 32}px`);
                }
                info(inst){}
                enum_states(){
                    return [
                        ['hv', [0, 1]]
                    ];
                }
                init_other_states(state){}
            }

            class FilterEnt extends EmptyEnt{
                constructor(delay){
                    super();
                    this.delay = delay;
                }
                can_place_item_on(inst){return true;}
                tick(inst){
                    if (inst.layer.time % this.delay != 0){
                        return;
                    }
                    //console.log(inst.x, inst.y);
                    if (inst.layer.item_sublayer.get_inst(inst.x, inst.y).type === item_table.get('empty')){
                        return;
                    }
                    
                    if (!inst.state.filter_inited){
                        inst.state.filter_inited = true;
                        inst.state.filter_item_type = inst.layer.item_sublayer.get_inst(inst.x, inst.y).type;
                        return;
                    }

                    let tick_time = Math.floor(inst.layer.time / this.delay);
                    let leftup = tick_time % 6 === 0 || tick_time % 6 === 1 || tick_time % 6 === 4;
                    let old_item_inst = inst.layer.item_sublayer.get_inst(inst.x, inst.y);
                    if (old_item_inst.type === inst.state.filter_item_type){
                        let [tx, ty] = entity_dir_target(inst);
                        if (entity_output_item(inst, tx, ty, old_item_inst.type, old_item_inst.state)){
                            inst.layer.next_item_sublayer.swap(inst.x, inst.y, item_table.get('empty'), null);
                            inst.layer.set_item_changed(inst.x, inst.y, true);
                        }
                    } else {
                        let tx = inst.x;
                        let ty = inst.y;
                        if (inst.state.hv === 0){
                            ty += leftup ? -1 : 1;
                        } else {
                            tx += leftup ? -1 : 1;
                        }
                        if (entity_output_item(inst, tx, ty, old_item_inst.type, old_item_inst.state)){
                            inst.layer.next_item_sublayer.swap(inst.x, inst.y, item_table.get('empty'), null);
                            inst.layer.set_item_changed(inst.x, inst.y, true);
                        }
                    }
                }
                draw(inst){
                    let rotation = ['0deg', '270deg', '90deg', '180deg'][inst.state.dir];
                    return $('<div>')
                        .css('background-image', `url('${this.icon}')`)
                        .css('background-size', '512px 512px')
                        .css('width', '100%').css('height', '100%')
                        .css('transform', `rotate(${rotation})`)
                        .css('background-position', `-${this.pos_x * 32}px -${this.pos_y * 32}px`);
                }
                info(inst){}
                enum_states(){
                    return [
                        ['dir', [0, 1, 2, 3]]
                    ];
                }
                init_other_states(state){
                    state.filter_inited = false;
                    state.filter_item_type = null;
                }
            }

            let total_produced = new Map();


            class MachineEnt extends EmptyEnt{
                constructor(ingredient_f, amounts, product_type, product_state, product_amount, cooldown_ticks){
                    super();
                    this.ingredient_f = ingredient_f;
                    this.amounts = amounts;
                    this.product_type = product_type;
                    this.product_state = product_state;
                    this.product_amount = product_amount;
                    this.cooldown_ticks = cooldown_ticks;
                    this.enable_lr_input = true;
                }
                can_place_item_on(inst){return false;}
                check_fulfill(inst){
                    if (inst.state.fulfilled){
                        return true;
                    }
                    let fulfilled = true;
                    $.each(this.amounts, (i, val) => {
                        if (inst.state.current_amounts[i] < val){
                            fulfilled = false;
                            return false;
                        }
                    });
                    return fulfilled;
                }
                set_fulfill(inst){
                    inst.state.fulfilled = true;
                    inst.state.remaining_output = this.product_amount;
                    inst.state.cooldown_ticks = this.cooldown_ticks;
                }
                tick(inst){
                    if (inst.state.remaining_output > 0){
                        if (inst.state.cooldown_ticks > 0){
                            inst.state.cooldown_ticks--;
                            return;
                        }
                        let [out_type, out_state] = [item_table.get('empty'), null];
                        if (this.on_output_item){
                            [out_type, out_state] = this.on_output_item(inst);
                        } else {
                            [out_type, out_state] = [this.product_type, this.product_state];
                        }
                        let [tx, ty] = entity_dir_target(inst);
                        if (entity_output_item(inst, tx, ty, out_type, out_state)){
                            total_produced.set(out_type.lookup_id, (total_produced.get(out_type.lookup_id) || 0) + 1);
                            inst.state.remaining_output--;
                            if (inst.state.remaining_output == 0){
                                this.init_other_states(inst.state);
                            }
                        }
                        return;
                    }
                    let [sx, sy] = entity_dir_source(inst);
                    if (inst.layer.time % 3 == 1){
                        [sx, sy] = entity_dir_source_left(inst);
                    } else if (inst.layer.time % 3 == 2){
                        [sx, sy] = entity_dir_source_right(inst);
                    }
                    if (inst.layer.get_item_changed(sx, sy)
                        || inst.layer.item_sublayer.get_inst(sx, sy).type === item_table.get('empty')){
                        return;
                    }
                    let ingredient_i = -1;
                    let input = inst.layer.item_sublayer.get_inst(sx, sy);
                    let [type, state] = [input.type, input.state];
                    if (this.on_input_item){
                        ingredient_i = this.on_input_item(inst, type, state);
                    } else {
                        ingredient_i = this.ingredient_f(type, state);
                    }
                    if (ingredient_i === -1){
                        return;
                    }
                    if (inst.state.current_amounts[ingredient_i] >= this.amounts[ingredient_i]){
                        return;
                    }
                    inst.state.current_amounts[ingredient_i]++;
                    inst.layer.next_item_sublayer.swap(sx, sy, item_table.get('empty'), null);
                    inst.layer.set_item_changed(sx, sy, true);

                    if (this.check_fulfill(inst)){
                        this.set_fulfill(inst);
                    }
                }
                draw(inst){
                    let rotation = ['0deg', '270deg', '90deg', '180deg'][inst.state.dir];
                    let div = $('<div>')
                        .css('background-image', `url('${this.icon}')`)
                        .css('background-size', '512px 512px')
                        .css('width', '100%').css('height', '100%')
                        .css('transform', `rotate(${rotation})`)
                        .css('background-position', `-${this.pos_x * 32}px -${this.pos_y * 32}px`);
                    let progress = $('<div>')
                        .css('position', 'absolute')
                        .css('width', '24px')
                        .css('height', '2px')
                        .css('top', '28px')
                        .css('left', '2px')
                        .css('border-left', '2px solid black')
                        .css('border-right', '2px solid black');
                    let bar = $('<div>')
                        .css('width', `${24*inst.state.cooldown_ticks / this.cooldown_ticks}px`)
                        .css('height', '2px')
                        .css('background-color', 'red');
                    progress.append(bar);
                    div.append(progress);
                    return div;
                }
                info(inst){
                    let $e = $('<span>');
                    if (this.basicinfo){
                        $e.append(this.basicinfo(inst));
                    }
                    $e.append($('<br><br>'));
                    let ing_names = [];
                    if (this.ing_names){
                        ing_names = this.ing_names(inst);
                    }
                    $e.append('输入原料: ')
                    $e.append($('<br>'));
                    for (let i in ing_names){
                        let name = ing_names[i];
                        let current_amount = inst.state.current_amounts[i];
                        let required_amount = inst.type.amounts[i];
                        if (current_amount == required_amount){
                            $e.append($('<span>').text(`${name}: ${current_amount}/${required_amount}`).css('color', 'green'));
                        } else {
                            $e.append($('<span>').text(`${name}: ${current_amount}/${required_amount}`));
                        }
                        $e.append($('<br>'));
                    }
                    $e.append($('<br>'));
                    if (inst.state.cooldown_ticks !== 0){
                        $e.append($('<span>').text('制作中...').css('color', 'red'));
                        $e.append($('<br>'));
                    }
                    if (inst.state.remaining_output !== 0 && inst.state.cooldown_ticks === 0){
                        $e.append($('<span>').text('输出物品中...').css('color', 'olive'));        
                        $e.append($('<br>'));
                    }
                    return $e;
                }
                enum_states(){
                    return [
                        ['dir', [0,1,2,3]],
                    ];
                }
                init_other_states(state){
                    state.fulfilled = false;
                    state.remaining_output = 0;
                    state.current_amounts = new Array(this.amounts.length).fill(0);
                    if (!state.cooldown_ticks){
                        state.cooldown_ticks = 0;
                    }
                }
            }

            class EmptyItem{
                draw(inst){}
                info(inst){}
                as_crafting_ingredient(inst){
                    return [inst.type, 1];
                }
            }

            class IconItem extends EmptyItem{
                constructor(icon, pos_x, pos_y){
                    super();
                    this.icon = icon;
                    this.pos_x = pos_x;
                    this.pos_y = pos_y;
                }
                draw(inst){
                    let opacity = 1;
                    if (this.life && inst.state && inst.state.life){
                        opacity = inst.state.life / this.life(inst) * 0.5 + 0.5;
                    }
                    return $('<div>')
                        .css('background-image', `url('${this.icon}')`)
                        .css('background-size', '512px 512px')
                        .css('background-position', `-${this.pos_x * 32}px -${this.pos_y * 32}px`)
                        .css('opacity', opacity)
                        .css('width', '32px').css('height', '32px');
                }
                info(inst){}
            }

            let item_table = new Map([
                ['empty', new EmptyItem()],
                ['crop', new IconItem("./texture.png", 0, 0)],
                ['food', new IconItem("./texture.png", 1, 0)],
                ['coal', new IconItem("./texture.png", 2, 0)],
                ['iron_ore', new IconItem("./texture.png", 3, 0)],
                ['uran_ore', new IconItem("./texture.png", 4, 0)],
                ['iron_ingot', new IconItem("./texture.png", 3, 1)],
                ['uran_ingot', new IconItem("./texture.png", 4, 1)],
                ['anti_iron_ingot', new IconItem("./texture.png", 3, 2)],
                ['lead_ingot', new IconItem("./texture.png", 4, 2)],
                ['fire', (()=>{let e = new IconItem("./texture.png", 0, 4); e.life = (inst)=>(120); e.kill_prob = (inst)=>(1-Math.pow(0.5, 1/20)); return e})()],
                ['light', (()=>{let e = new IconItem("./texture.png", 1, 4); e.life = (inst)=>(120); e.kill_prob = (inst)=>(1-Math.pow(0.5, 1/20)); return e})()],
                ['elec', (()=>{let e = new IconItem("./texture.png", 2, 4); e.life = (inst)=>(120); e.kill_prob = (inst)=>(1-Math.pow(0.5, 1/20)); return e})()],
                ['wormhole', new IconItem("./texture.png", 4, 4)],
                ['coin', new IconItem("./texture.png", 0, 5)],
            ]);

            let entity_table = new Map([
                ['empty', new EmptyEnt()],
                ['belt', (()=>{
                    let e = new BeltEnt(5); e.icon='./texture.png'; e.pos_x=0; e.pos_y=6;
                    e.info = (inst)=>('普通的传送带，1秒可以将物品运输4格。');
                    return e
                })()],
                ['fast_belt', (()=>{
                    let e = new BeltEnt(3); e.icon='./texture.png'; e.pos_x=1; e.pos_y=6;
                    e.info = (inst)=>('更好的传送带，1秒可以将物品运输7格。');
                    return e
                })()],
                ['faster_belt', (()=>{
                    let e = new BeltEnt(1); e.icon='./texture.png'; e.pos_x=2; e.pos_y=6;
                    e.info = (inst)=>('使用金属铅加强过的传送带，可以承受更高的旋转速度，1秒可以将物品运输20格。');
                    return e
                })()],
                ['ladder', (()=>{
                    let e = new LadderEnt(5); e.icon='./texture.png'; e.pos_x=0; e.pos_y=7;
                    e.info = (inst)=>('传送梯，将物品在地表和地下间运输。');
                    return e
                })()],
                ['router', (()=>{
                    let e = new RouterEnt(1); e.icon='./texture.png'; e.pos_x=1; e.pos_y=7;
                    e.info = (inst)=>('分流器，将其上的物品分流到两侧。');
                    return e
                })()],
                ['filter', (()=>{
                    let e = new FilterEnt(5); e.icon='./texture.png'; e.pos_x=2; e.pos_y=7;
                    e.info = (inst)=>(
                        $('<span>')
                            .append('过滤器，记住其上的第一个物品，使此类物品通过，其他物品分流至两侧。')
                            .append($('<br><br>'))
                            .append('更改方向后会自动清除物品')
                            .append($('<br><br>'))
                            .append(inst.state.filter_inited ? '当前物品: ' : '当前没有物品')
                            .append(inst.state.filter_inited ? inst.state.filter_item_type.draw(null) : null));
                    return e
                })()],
                ['gravity_gen', (()=>{
                    let e = new MachineEnt((type, state)=>(-1), [1], item_table.get('elec'), null, 6, 50);
                    e.icon='./texture.png'; e.pos_x=0; e.pos_y=9;
                    e.info = (inst)=>(
                        $('<span>')
                            .append('抬升机，依靠重力带动发电机发电。'));
                    return e
                })()],
                ['villager', (()=>{
                    let e = new MachineEnt(
                        (type, state)=>(type == item_table.get('food') ? 0 : -1),
                        [1], item_table.get('empty'), null, 1, 100
                    );
                    e.on_output_item = (inst) => {
                        let gravity_gen_txy = [];
                        for (let dir = 0; dir < 4; dir++){
                            let [dx, dy] = cardinal[dir];
                            let [tx, ty] = [inst.x + dx, inst.y + dy];
                            if (inst.layer.get_entity_changed(tx, ty)){
                                continue;
                            }
                            if (inst.layer.entity_sublayer.get_inst(tx, ty).type == entity_table.get('gravity_gen')){
                                gravity_gen_txy.push([tx, ty]);
                            }
                        }
                        if (gravity_gen_txy.length <= 0){
                            return [null, null];
                        }
                        let target_gravity_gen_i = Math.floor(Math.random() * gravity_gen_txy.length);
                        let [tx, ty] = gravity_gen_txy[target_gravity_gen_i];
                        let gen_inst = inst.layer.next_entity_sublayer.get_inst(tx, ty);
                        if (gen_inst.type.check_fulfill(gen_inst)){
                            return [null, null];
                        }
                        gen_inst.type.set_fulfill(gen_inst);
                        return [item_table.get('empty'), null];
                    }
                    e.basicinfo = (inst)=>("为你工作的村民，吃食物后可以激活旁边的抬升机。");
                    e.ing_names = (inst)=>(["食物"]);
                    e.icon='./texture.png'; e.pos_x=2; e.pos_y=9; return e
                })()],
                ['stove', (()=>{
                    let e = new MachineEnt(
                        null,
                        [1], item_table.get('empty'), null, 1, 100
                    );
                    e.on_input_item = (inst, type, state)=>{
                        if (type == item_table.get('coal')){
                            inst.state.recipe = 'coal';
                        } else if (type == item_table.get('crop')){
                            inst.state.recipe = 'crop';
                        } else if (type == item_table.get('food')){
                            inst.state.recipe = 'food';
                        }
                        inst.state.coal_output_amount_init = false;
                        return (type == item_table.get('coal') || type == item_table.get('crop') || type == item_table.get('food')) ? 0 : -1;
                    }
                    e.on_output_item = (inst) => {
                        if (inst.state.recipe == 'coal'){
                            if (!inst.state.coal_output_amount_init){
                                inst.state.coal_output_amount_init = true;
                                inst.state.remaining_output = 9;
                            }
                            return [item_table.get('fire'), null];
                        } else if (inst.state.recipe == 'crop'){
                            return [item_table.get('food'), null];
                        } else if (inst.state.recipe == 'food'){
                            return [item_table.get('coal'), null];
                        } else {
                            return [item_table.get('empty'), null];
                        }
                    }
                    e.basicinfo = (inst)=>("火炉，可以将煤燃烧成火，将粮食做成食物，将食物烧成煤。");
                    e.ing_names = (inst)=>(["可燃烧物"]);
                    e.icon='./texture.png'; e.pos_x=3; e.pos_y=9; return e
                })()],
                ['steam_gen', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('fire') ? 0 : -1), [2], item_table.get('elec'), null, 1, 10);
                    e.basicinfo = (inst)=>("蒸汽发电机，可以使用火来发电。");
                    e.ing_names = (inst)=>(["火"]);
                    e.icon='./texture.png'; e.pos_x=4; e.pos_y=9; return e
                })()],
                ['farm', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('light') ? 0 : -1), [12], item_table.get('food'), null, 1, 100);
                    e.basicinfo = (inst)=>("大棚农场，吸收外界的光促进植物生长，可以产出粮食。");
                    e.ing_names = (inst)=>(["光"]);
                    e.icon='./texture.png'; e.pos_x=5; e.pos_y=9; return e
                })()],
                ['magnifier', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('light') ? 0 : -1), [2], item_table.get('fire'), null, 1, 10);
                    e.basicinfo = (inst)=>("放大镜，上面的凸透镜可以将光聚焦起来，产生火。");
                    e.ing_names = (inst)=>(["光"]);
                    e.icon='./texture.png'; e.pos_x=6; e.pos_y=9; return e
                })()],
                ['lightbulb', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('elec') ? 0 : -1), [3], item_table.get('empty'), null, 3, 10);
                    e.on_output_item = (inst) => {
                        let is_fire = Math.random() * 3 < 2;
                        if (is_fire){
                            return [item_table.get('fire'), null];
                        } else {
                            return [item_table.get('light'), null];
                        }
                    }
                    e.basicinfo = (inst)=>("白炽灯，消耗电，大多数电都用作加热灯丝了，只有少数电可以用来发光。");
                    e.ing_names = (inst)=>(["电"]);
                    e.icon='./texture.png'; e.pos_x=7; e.pos_y=9; return e
                })()],
                ['led', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('elec') ? 0 : -1), [1], item_table.get('light'), null, 1, 3);
                    e.basicinfo = (inst)=>("利用半导体科技制作的发光二极管，可以将输入的所有电能转化成光能。");
                    e.ing_names = (inst)=>(["电"]);
                    e.icon='./texture.png'; e.pos_x=8; e.pos_y=9; return e
                })()],
                ['elec_furnace', (()=>{
                    let e = new MachineEnt(null, [1, 24], item_table.get('iron_ingot'), null, 24, 100);
                    e.on_input_item = (inst, type, state) => {
                        if (inst.state.current_amounts[0] === 0){
                            return type === item_table.get('iron_ore') ? 0 : -1;
                        } else {
                            return type === item_table.get('elec') ? 1 : -1;
                        }
                    }
                    e.basicinfo = (inst)=>("电炉，利用电将铁矿冶炼成铁锭。");
                    e.ing_names = (inst)=>(['铁矿', "电"]);
                    e.icon='./texture.png'; e.pos_x=0; e.pos_y=10; return e
                })()],
                ['uran_furnace', (()=>{
                    let e = new MachineEnt(null, [1, 24], item_table.get('uran_ingot'), null, 3, 100);
                    e.on_input_item = (inst, type, state) => {
                        if (inst.state.current_amounts[0] === 0){
                            return type === item_table.get('uran_ore') ? 0 : -1;
                        } else {
                            return type === item_table.get('elec') ? 1 : -1;
                        }
                    }

                    e.basicinfo = (inst)=>("铀离心机，将铀矿处理为可供给反应堆的铀锭。");
                    e.ing_names = (inst)=>(["铀矿", '电']);
                    e.icon='./texture.png'; e.pos_x=0; e.pos_y=10; return e
                })()],
                ['battery', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('iron_ingot') ? 0 : -1), [24], item_table.get('empty'), null, 21, 100);
                    e.on_output_item = (inst) => {
                        if (inst.state.remaining_output == 1){
                            return [item_table.get('iron_ore'), null];
                        } else {
                            return [item_table.get('elec'), null];
                        }
                    }
                    e.basicinfo = (inst)=>("化学原电池，可以从金属铁到铁矿的反应中获取电能。");
                    e.ing_names = (inst)=>(['铁锭']);
                    e.icon='./texture.png'; e.pos_x=1; e.pos_y=10; return e
                })()],
                ['nuclear_reactor', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('uran_ingot') ? 0 : -1), [1], item_table.get('empty'), null, 145, 100);
                    e.on_output_item = (inst) => {
                        if (inst.state.remaining_output == 1){
                            return [item_table.get('lead_ingot'), null];
                        } else {
                            return [item_table.get('fire'), null];
                        }
                    }
                    e.basicinfo = (inst)=>("核反应堆，从铀元素的链式裂变反应中获取能量。");
                    e.ing_names = (inst)=>(['铀锭']);
                    e.icon='./texture.png'; e.pos_x=2; e.pos_y=10; return e
                })()],
                ['nuclear_antireactor', (()=>{
                    let e = new MachineEnt(null, [1, 168], item_table.get('uran_ingot'), null, 1, 100);
                    e.on_input_item = (inst, type, state) => {
                        if (inst.state.current_amounts[0] === 0){
                            return type === item_table.get('lead_ingot') ? 0 : -1;
                        } else {
                            return type === item_table.get('fire') ? 1 : -1;
                        }
                    }
                    e.basicinfo = (inst)=>("核子置入器，使用能量将质子和中子塞入铅原子核中，产生铀元素。");
                    e.ing_names = (inst)=>(['铅锭', '火']);
                    e.icon='./texture.png'; e.pos_x=3; e.pos_y=10; return e
                })()],
                ['anitimatter_gen', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('light') ? 0 : (type == item_table.get('fire') ? 1 : -1)), [144*4, 144*4], item_table.get('empty'), null, 2, 100);
                    e.on_output_item = (inst) => {
                        if (inst.state.remaining_output == 1){
                            return [item_table.get('anti_iron_ingot'), null];
                        } else {
                            return [item_table.get('iron_ingot'), null];
                        }
                    }
                    e.basicinfo = (inst)=>("光子对撞机，使用极高能量将光子转化为正反物质，以铁和反铁的形式储存在引力井中。");
                    e.ing_names = (inst)=>(['光', '火']);
                    e.icon='./texture.png'; e.pos_x=4; e.pos_y=10; return e
                })()],
                ['anitimatter_reactor', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('iron_ingot') ? 0 : (type == item_table.get('anti_iron_ingot') ? 1 : -1)), [1, 1], item_table.get('empty'), null, 144*4+136*4, 100);
                    e.on_output_item = (inst) => {
                        if ((inst.state.remaining_output - 1) % (18+17) < 18){
                            return [item_table.get('light'), null];
                        } else {
                            return [item_table.get('elec'), null];
                        }
                    }
                    e.basicinfo = (inst)=>("约束反应器，操纵引力壁垒，使引力井中的正反物质缓慢湮灭，放出光能和电能。");
                    e.ing_names = (inst)=>(['光', '火']);
                    e.icon='./texture.png'; e.pos_x=5; e.pos_y=10; return e
                })()],
                ['wormhole_gen', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('elec') ? 0 : (type == item_table.get('light') ? 1 : -1)), [1728, 1728], item_table.get('wormhole'), null, 1, 100);
                    e.basicinfo = (inst)=>("时空界面，通过操作和折叠极端能量条件下的空间，制造稳定的微虫洞，其中包含巨大能量。");
                    e.ing_names = (inst)=>(['电', '光']);
                    e.icon='./texture.png'; e.pos_x=6; e.pos_y=10; return e
                })()],
                ['wormhole_reactor', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('wormhole') ? 0 : -1), [1], item_table.get('empty'), null, 1728+1680, 100);
                    e.on_output_item = (inst) => {
                        if ((inst.state.remaining_output - 1) % (36+35) < 36){
                            return [item_table.get('elec'), null];
                        } else {
                            return [item_table.get('fire'), null];
                        }
                    }
                    e.basicinfo = (inst)=>("反时空界面，解构微虫洞内部的空间结构，利用时空的展开获取巨大能量，放出电能和热能。");
                    e.ing_names = (inst)=>(['微虫洞']);
                    e.icon='./texture.png'; e.pos_x=7; e.pos_y=10; return e
                })()],
                ['coin_maker', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('elec') ? 0 : -1), [6], item_table.get('coin'), null, 1, 120);
                    e.basicinfo = (inst)=>("电动车充电站，通过给邻居家的电动车充电赚钱。");
                    e.ing_names = (inst)=>(['电']);
                    e.icon='./texture.png'; e.pos_x=0; e.pos_y=11; return e
                })()],
                ['elec_meter', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('coin') ? 0 : -1), [1], item_table.get('elec'), null, 12, 120);
                    e.can_be_moved = (inst) => {return false;};
                    e.basicinfo = (inst)=>("电表，输入钱就可以买电");
                    e.ing_names = (inst)=>(['钱币']);
                    e.icon='./texture.png'; e.pos_x=5; e.pos_y=11; return e
                })()],
                ['drill', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('elec') ? 0 : -1), [6], item_table.get('empty'), null, 24, 120);
                    e.mine = (inst) => {
                        let hash = (53 + inst.y * 101) * 53 + inst.x * 101;
                        let m = hash % 32;
                        if (m < 10){
                            return 'coal';
                        } else {
                            return 'iron';
                        }
                    }
                    e.on_output_item = (inst) => {
                        let recipe = e.mine(inst);
                        if (recipe == 'coal'){
                            return [item_table.get('coal'), null];
                        } else if (recipe == 'iron'){
                            if (inst.state.remaining_output < 24){
                                return [item_table.get('empty'), null];
                            } else {
                                return [item_table.get('iron_ore'), null];
                            }
                        }
                    }
                    var original_tick = e.tick.bind(e);
                    e.tick = (inst)=>{
                        if (inst.layer.is_underground){
                            original_tick(inst);
                        }
                    }
                    e.basicinfo = (inst)=>{
                        let s = "挖矿钻头，只能在地下工作，依照所处的位置不同，可能挖出铁矿或煤。";
                        if (inst.layer.is_underground){
                            return s;
                        } else {
                            return s + '<br><br> <span style="color: red;">不能在地表工作</span>';
                        }
                    };
                    e.ing_names = (inst)=>(['电']);
                    e.icon='./texture.png'; e.pos_x=1; e.pos_y=11; return e
                })()],
                ['uran_drill', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('elec') ? 0 : (type == item_table.get('iron_ingot') ? 1 : -1)), [6, 12], item_table.get('uran_ore'), null, 24, 480);
                    var original_tick = e.tick.bind(e);
                    e.tick = (inst)=>{
                        if (inst.layer.is_underground){
                            original_tick(inst);
                        }
                    }
                    e.basicinfo = (inst)=>{
                        let s = "深层挖矿钻头，只能在地下工作，需要消耗铁锭，能够挖出铀矿。";
                        if (inst.layer.is_underground){
                            return s;
                        } else {
                            return s + '<br><br> <span style="color: red;">不能在地表工作</span>';
                        }
                    };
                    e.ing_names = (inst)=>(['电', '铁锭']);
                    e.icon='./texture.png'; e.pos_x=1; e.pos_y=11; return e
                })()],
                ['antimatter_enricher', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('anti_iron_ingot') ? 0 : (type == item_table.get('lead_ingot') ? 1 : -1)), [24, 6], item_table.get('empty'), null, 25, 100);
                    e.on_output_item = (inst) => {
                        if (inst.state.remaining_output == 1){
                            if (Math.random() < 0.75){
                                return [item_table.get('anti_iron_ingot'), null];
                            } else {
                                return [item_table.get('empty'), null];
                            }
                        } else {
                            return [item_table.get('anti_iron_ingot'), null];
                        }
                    }
                    e.basicinfo = (inst)=>("反物质增殖装置，使用物质和反物质的交互作用，进行反物质的远距交换。消耗重元素金属铅，将反铁变多。因为宇宙环境的不稳定性，增殖过程有可能会失败。");
                    e.ing_names = (inst)=>(['反铁锭', '铅锭']);
                    e.icon='./texture.png'; e.pos_x=2; e.pos_y=11; return e
                })()],
                ['wormhole_enricher', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('wormhole') ? 0 : (type == item_table.get('anti_iron_ingot') ? 1 : -1)), [12, 3], item_table.get('empty'), null, 13, 100);
                    e.on_output_item = (inst) => {
                        if (inst.state.remaining_output == 1){
                            if (Math.random() < 0.75){
                                return [item_table.get('wormhole'), null];
                            } else {
                                return [item_table.get('empty'), null];
                            }
                        } else {
                            return [item_table.get('wormhole'), null];
                        }
                    }
                    e.basicinfo = (inst)=>("宇宙际强力浓差虫洞增殖装置，使用多元宇宙的物理特性差别，展开已有微虫洞中蕴含的连续时空，使用反物质交换出平行宇宙中存在的微虫洞。因为平行宇宙的时空特性不稳定，增殖过程有可能会失败。");
                    e.ing_names = (inst)=>(['微虫洞', '反铁锭']);
                    e.icon='./texture.png'; e.pos_x=3; e.pos_y=11; return e
                })()],
                ['store_food', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('coin') ? 0 : -1), [2], item_table.get('food'), null, 1, 100);
                    e.basicinfo = (inst)=>("商店，在这里可以买食物。");
                    e.ing_names = (inst)=>(['钱币']);
                    e.can_be_moved = (inst)=>{return false;}
                    e.icon='./texture.png'; e.pos_x=4; e.pos_y=11; return e
                })()],
                ['store_coal', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('coin') ? 0 : -1), [3], item_table.get('coal'), null, 1, 100);
                    e.basicinfo = (inst)=>("商店，在这里可以买煤。");
                    e.ing_names = (inst)=>(['钱币']);
                    e.can_be_moved = (inst)=>{return false;}
                    e.icon='./texture.png'; e.pos_x=4; e.pos_y=11; return e
                })()],
                ['store_iron', (()=>{
                    let e = new MachineEnt((type, state)=>(type == item_table.get('coin') ? 0 : -1), [3], item_table.get('iron_ingot'), null, 1, 100);
                    e.basicinfo = (inst)=>("商店，在这里可以买铁锭。");
                    e.ing_names = (inst)=>(['钱币']);
                    e.can_be_moved = (inst)=>{return false;}
                    e.icon='./texture.png'; e.pos_x=4; e.pos_y=11; return e
                })()],
                ['wall', (()=>{
                    let e = new WallEnt();
                    return e
                })()],
                ['big_wormhole', (()=>{
                    let e = new LadderEnt(5); e.icon='./texture.png'; e.pos_x=4; e.pos_y=4;
                    e.info = (inst)=>('<span style="color: purple;">虫洞，通往异世界的传送门。</span><br>制作后将会通关，记得制作之前保存游戏。');
                    return e
                })()],
            ]);

            for (let [k, v] of item_table){
                v.lookup_id = k;
            }
            for (let [k, v] of entity_table){
                v.lookup_id = k;
            }

            class YardSubLayer{
                constructor(layer, init_val){
                    this.layer = layer;
                    this.empty(init_val);
                }

                swap(x, y, new_type, new_state){
                    const i = this.layer.xy2i(x, y);
                    const old_type = this.type[i];
                    const old_state = this.state.get(i) || null;
                    this.state.delete(i);
                    this.type[i] = new_type;
                    if (new_state !== null){
                        this.state.set(i, new_state);
                    }
                    return [old_type, old_state];
                }

                make_cont(width, height){
                    if (!width) {width = this.layer.width}
                    if (!height) {height = this.layer.height}
                    let $sublayer_cont = $('<div>').addClass('sublayer-cont');
                    for (let y=0; y<height; y++){
                        for (let x=0; x<width; x++){
                            const wrapper = $('<div>').addClass('cell-wrapper').data('x', x).data('y', y);
                            $sublayer_cont.append(wrapper);
                        }
                        $sublayer_cont.append($('<br>'));
                    }
                    return $sublayer_cont;
                }

                get_inst(x, y){
                    let state = this.state.get(this.layer.xy2i(x, y)) || null;
                    let type = this.type[this.layer.xy2i(x, y)];
                    return {
                        layer: this.layer,
                        x: x,
                        y: y,
                        type: type,
                        state: state,
                    }
                }

                draw_all($sublayer_cont){
                    let that = this;
                    $sublayer_cont.children('.cell-wrapper').each((_, wrapper)=>{
                        let $wrapper = $(wrapper);
                        const x = $wrapper.data('x');
                        const y = $wrapper.data('y');
                        $wrapper.empty();
                        let inst = that.get_inst(x, y);
                        let c = inst.type.draw(inst);
                        $wrapper.append(c);
                    });
                }


                empty(init_val){
                    this.type = new Array(this.layer.width * this.layer.height).fill(init_val);
                    this.state = new Map();
                }
            }

            class YardLayer{
                constructor(width, height){
                    this.width = width;
                    this.height = height;
                    this.entity_sublayer = new YardSubLayer(this, entity_table.get('empty'));
                    this.next_entity_sublayer = new YardSubLayer(this, entity_table.get('empty'));
                    this.entity_changed = new Array(this.width * this.height).fill(false);
                    this.item_sublayer = new YardSubLayer(this, item_table.get('empty'));
                    this.next_item_sublayer = new YardSubLayer(this, item_table.get('empty'));
                    this.item_changed = new Array(this.width * this.height).fill(false);
                    this.time = 0;
                    this.daynight = 0; // 0~0.5: day, 0.5~1: night
                }

                get_entity_changed(x, y){
                    return this.entity_changed[this.xy2i(x, y)];
                }
                
                set_entity_changed(x, y, val){
                    this.entity_changed[this.xy2i(x, y)] = val;
                }

                get_item_changed(x, y){
                    return this.item_changed[this.xy2i(x, y)];
                }

                set_item_changed(x, y, val){
                    this.item_changed[this.xy2i(x, y)] = val;
                }

                can_place_item_on(x, y){
                    if (!this.is_in_border(x, y)){
                        return false;
                    }
                    let inst = this.entity_sublayer.get_inst(x, y);
                    let ninst = this.next_entity_sublayer.get_inst(x, y);
                    return inst.type.can_place_item_on(inst) && ninst.type.can_place_item_on(ninst);
                }

                xy2i(x, y){
                    return this.width * y + x;
                }

                i2xy(i){
                    return [i % this.width, Math.floor(i / this.width)];
                }

                is_in_border(x, y){
                    return 0 <= x && x < this.width && 0 <= y && y < this.height;
                }

                do_tick_reversed(){
                    return this.time % 4 < 2;
                }

                tick_all(){
                    // process item life
                    for (let y=0; y<this.height; y++){
                        for (let x=0; x<this.width; x++){
                            let item_inst = this.item_sublayer.get_inst(x, y);
                            if (item_inst.type.life !== undefined){
                                if (item_inst.state === null){
                                    this.next_item_sublayer.swap(x, y, item_inst.type, {life: item_inst.type.life(item_inst)});
                                    this.set_item_changed(x, y, true);
                                } else if (item_inst.state.life === undefined){
                                    item_inst.state.life = item_inst.type.life(item_inst);
                                } else if (item_inst.state.life > 0){
                                    item_inst.state.life--;
                                } else if (item_inst.state.life == 0){
                                    if (Math.random() < item_inst.type.kill_prob(item_inst)){
                                        this.next_item_sublayer.swap(x, y, item_table.get('empty'), null);
                                        this.set_item_changed(x, y, true);
                                    }
                                }
                                
                            }
                        }
                    }
                    if (this.do_tick_reversed()){
                        for (let y=0; y<this.height; y++){
                            for (let x=0; x<this.width; x++){
                                this.tick_at(this.width - x - 1, this.height - y - 1);
                            }
                        }
                    } else {
                        for (let y=0; y<this.height; y++){
                            for (let x=0; x<this.width; x++){
                                this.tick_at(x, y);
                            }
                        }
                    }
                    this.item_sublayer.type = [...this.next_item_sublayer.type];
                    this.item_sublayer.state = new Map(this.next_item_sublayer.state);
                    this.item_changed.fill(false);
                    this.entity_sublayer.type = [...this.next_entity_sublayer.type];
                    this.entity_sublayer.state = new Map(this.next_entity_sublayer.state);
                    this.entity_changed.fill(false);
                    this.time++;
                    this.daynight = this.time / 20 / 120;
                }

                tick_at(x, y){
                    let inst = this.entity_sublayer.get_inst(x, y);
                    inst.type.tick(inst);
                }

                on_mouse_place_entity(inst){
                    return {
                        able: true,
                        type: entity_table.get('empty'),
                        state: null
                    };
                }

                layer_specific_info(inst){
                    return null;
                }

                make_cont(callback_output_info, callback_clear_info, width, height){
                    if (!width){width = this.width}
                    if (!height){height = this.height}
                    let $cont = $('<div>').addClass('layer-cont');
                    let $grid_cont = this.entity_sublayer.make_cont(width, height).addClass('grid-cont');
                    let $entity_cont = this.entity_sublayer.make_cont(width, height).addClass('entity-sublayer-cont');
                    let $item_cont = this.item_sublayer.make_cont(width, height).addClass('item-sublayer-cont');
                    let $mouseclick_cont = this.entity_sublayer.make_cont(width, height).addClass('mouseclick-cont');
                    $mouseclick_cont.children('.cell-wrapper').on('click', (e)=>{
                        let x = $(e.target).data('x');
                        let y = $(e.target).data('y');
                        let inst = this.next_entity_sublayer.get_inst(x, y);
                        let res = this.on_mouse_place_entity(inst);
                        if (!res.able){
                            return;
                        }
                        this.next_entity_sublayer.swap(x, y, res.type, res.state);
                    });
                    let task_id = null;
                    $mouseclick_cont.children('.cell-wrapper').on('mouseenter', (e)=>{
                        let i = $(e.target).index();
                        let x = $(e.target).data('x');
                        let y = $(e.target).data('y');
                        $($mouseclick_cont.children()[i]).css('background-color', 'rgba(255, 255, 0, 0.2)');
                        $($item_cont.children()[i]).css('opacity', '0.2');
                        let f = ()=>{
                            let inst = this.next_entity_sublayer.get_inst(x, y);
                            if (callback_output_info){
                                let $d = $('<div>');
                                $d.append(inst.type.info(inst));
                                $d.append(this.layer_specific_info(inst));
                                callback_output_info($d);
                            }
                        }
                        f();
                        task_id = setInterval(f, 200);
                    });
                    $mouseclick_cont.children('.cell-wrapper').on('mouseleave', (e)=>{
                        let i = $(e.target).index();
                        let x = $(e.target).data('x');
                        let y = $(e.target).data('y');
                        $($mouseclick_cont.children()[i]).css('background-color', '');
                        $($item_cont.children()[i]).css('opacity', '');
                        clearInterval(task_id);
                        if (callback_clear_info){
                            callback_clear_info();
                        }
                    });
                    $cont.append($grid_cont).append($entity_cont).append($item_cont).append($mouseclick_cont);
                    return $cont;
                }

                draw_all($layer_cont){
                    let $entity_cont = $layer_cont.children('.entity-sublayer-cont');
                    let $item_cont = $layer_cont.children('.item-sublayer-cont');
                    this.next_entity_sublayer.draw_all($entity_cont);
                    this.next_item_sublayer.draw_all($item_cont);
                }
            }

            function clear_info(){
                $('.item-info').empty();
            }

            let yard_offset_x = 0;
            let yard_offset_y = 0;

            function clear_and_show_hand(){
                let entity_inst = hand_layer.get_entity_inst();
                let info = entity_inst.type.info(entity_inst);
                $('.item-info').empty();
                $('.item-info').append(info);
                if (debug_tooltip){
                    $('.item-debug-state').empty();
                    $('.item-debug-state').append(JSON.stringify(entity_inst.state));
                    $('.item-debug-state').append('\n');
                    $('.item-debug-state').append(`offx=${yard_offset_x}, offy=${yard_offset_y}`);
                }
            }

            function show_info(info){
                clear_info();
                $('.item-info').append(info);
            }
            
        
            let ground_layer = new YardLayer(52, 36);
            let underground_layer = new YardLayer(52, 36);
            ground_layer.ladder_layer = underground_layer;
            underground_layer.ladder_layer = ground_layer;
            ground_layer.is_underground = false;
            underground_layer.is_underground = true;

            ground_layer.on_mouse_place_entity = underground_layer.on_mouse_place_entity = (inst)=>{
                if (!inst.type.can_be_moved(inst)){
                    return {
                        able: false
                    };
                }
                if (inst.layer.hand_layer.next_entity_sublayer.get_inst(0, 0).type === entity_table.get('ladder')){
                    // 梯子只能放到指定位置
                    if (23 <= inst.x && inst.x <= 47 && 1 <= inst.y && inst.y <= 9){
                        // pass
                        // 后院
                    } else if (14 <= inst.x && inst.x <= 21 && 3 <= inst.y && inst.y <= 8){
                        // pass
                        // 合成空间的小区域
                    } else {
                        let hash = (53 + inst.y * 101) * 53 + inst.x * 101;
                        let m = hash % 32; // 随机位置
                        if (m > 20){
                            show_prompt('地面太硬挖不了洞，不能放梯子');
                            return {
                                able: false
                            }
                        }
                    }
                }
                let [swap_out_type, swap_out_state] = inst.layer.hand_layer.next_entity_sublayer.swap(0, 0, inst.type, inst.state);
                hand_autosupply();
                redraw_hand_and_selector();
                return {
                    able: true,
                    type: swap_out_type,
                    state: swap_out_state
                };
            }
            
            let $layer_cont = ground_layer.make_cont(show_info, clear_and_show_hand, 24, 16).addClass('ground-layer-cont');
            let $underground_layer_cont = underground_layer.make_cont(show_info, clear_and_show_hand, 24, 16).addClass('underground-layer-cont');
            $('#yard-cont-inner').append($layer_cont);
            $('#yard-cont-inner').append($underground_layer_cont);

            let hand_layer = new YardLayer(6, 1);
            hand_layer.get_entity_inst = function(){
                return this.next_entity_sublayer.get_inst(0, 0);
            }
            hand_layer.get_item_inst = function(){
                return this.next_item_sublayer.get_inst(0, 0);
            }
            let $hand_layer_cont = hand_layer.make_cont(show_info, clear_and_show_hand);
            $('#hand-cont').append($hand_layer_cont);
            ground_layer.hand_layer = hand_layer;
            underground_layer.hand_layer = hand_layer;

            hand_layer.on_mouse_place_entity = (inst)=>{
                let [x, y] = [inst.x, inst.y];
                let i = inst.layer.xy2i(inst.x, inst.y);
                if (i === 0){
                    return {
                        able: false
                    };
                }
                let [orig_hand_type, orig_hand_state] = hand_layer.next_entity_sublayer.swap(0, 0, entity_table.get('empty'), null);
                let [swap_out_type, swap_out_state] = hand_layer.next_entity_sublayer.swap(x, y, orig_hand_type, orig_hand_state);
                hand_layer.next_entity_sublayer.swap(0, 0, swap_out_type, swap_out_state);
                redraw_hand_and_selector();
                return {
                    able: false
                };
            }

            function hand_has_space(){
                let i=0;
                let [x, y] = hand_layer.i2xy(i);
                while (hand_layer.entity_sublayer.get_inst(x, y).type !== entity_table.get('empty')){
                    i++;
                    [x, y] = hand_layer.i2xy(i);
                    if (i>= hand_layer.width * hand_layer.height){
                        return false;
                    }
                }
                return true;
            }

            function hand_autosupply(){
                let i=0;
                let [x, y] = hand_layer.i2xy(i);
                while (hand_layer.next_entity_sublayer.get_inst(x, y).type === entity_table.get('empty')){
                    i++;
                    [x, y] = hand_layer.i2xy(i);
                    if (i>= hand_layer.width * hand_layer.height){
                        return false;
                    }
                }
                if (i === 0){
                    return true;
                }
                let [orig_hand_type, orig_hand_state] = hand_layer.next_entity_sublayer.swap(0, 0, entity_table.get('empty'), null);
                let [swap_out_type, swap_out_state] = hand_layer.next_entity_sublayer.swap(x, y, orig_hand_type, orig_hand_state);
                hand_layer.next_entity_sublayer.swap(0, 0, swap_out_type, swap_out_state);
                return true;
            }

            function hand_autoinsert(type, state){
                let i=0;
                let [x, y] = hand_layer.i2xy(i);
                while (hand_layer.next_entity_sublayer.get_inst(x, y).type !== entity_table.get('empty')){
                    i++;
                    [x, y] = hand_layer.i2xy(i);
                    if (i>= hand_layer.width * hand_layer.height){
                        return false;
                    }
                }
                hand_layer.next_entity_sublayer.swap(x, y, type, state);
                return true;
            }

            $('#hand-cont .layer-cont').append($('<div>').addClass('hand-main-indicator'))

            let $state_selector_cont = $('<div>').addClass('state-selector-cont');
            $('#info-cont').append($('<div>').addClass('item-info'));
            $('#info-cont').append($('<div>').addClass('item-debug-state'));
            $state_selector_cont.append($('<div>').addClass('state-enum'));
            let selector_layer = new YardLayer(8, 2);
            let $selector_layer_cont = selector_layer.make_cont(show_info, clear_and_show_hand);
            $state_selector_cont.children('.state-enum').append($selector_layer_cont);
            $('#state-selector-cont').append($state_selector_cont);

            let selected_states = new Map();

            selector_layer.on_mouse_place_entity = (inst)=>{
                if (inst.type === entity_table.get('empty')){
                    return {
                        able: false
                    };
                }
                for (let [state_name, state_values] of inst.type.enum_states()){
                    selected_states.set(state_name, inst.state[state_name]);
                }
                let [swap_out_type, swap_out_state] = hand_layer.next_entity_sublayer.swap(0, 0, inst.type, inst.state);
                hand_autosupply();
                redraw_hand_and_selector();
                return {
                    able: false
                };
            }

            function redraw_hand_and_selector(){
                let entity_inst = hand_layer.get_entity_inst();
                hand_layer.draw_all($hand_layer_cont);
                clear_and_show_hand();
                let enum_states = entity_inst.type.enum_states();
                let x=0, y=0;
                selector_layer.next_entity_sublayer.empty(entity_table.get('empty'));
                let trimmed_state = {};
                for (let [state_key, state_values] of enum_states){
                    trimmed_state[state_key] = entity_inst.state[state_key];
                }
                entity_inst.type.init_other_states(trimmed_state);
                for (let [state_key, state_values] of enum_states){
                    for (let v of state_values){
                        let new_state = structuredClone(trimmed_state);
                        new_state[state_key] = v;
                        selector_layer.next_entity_sublayer.swap(x, y, entity_inst.type, new_state);
                        x++;
                    }
                    y++
                }
                selector_layer.draw_all($selector_layer_cont);
            }
            redraw_hand_and_selector();

            let crafting_layer = new YardLayer(8, 5);

            let crafting_recipes = [
                {out: 'belt' ,in: [['iron_ingot', 6]]},
                {out: 'fast_belt' ,in: [['iron_ingot', 12], ['coal', 6]]},
                {out: 'faster_belt' ,in: [['iron_ingot', 24], ['lead_ingot', 1]]},
                {out: 'ladder' ,in: [['iron_ingot', 24]]},
                {out: 'router' ,in: [['iron_ingot', 12]]},
                {out: 'filter' ,in: [['iron_ingot', 12]]},
                {out: 'gravity_gen' ,in: [['iron_ingot', 24], ['coal', 12]]},
                {out: 'villager' ,in: [['coal', 12], ['food', 12]]},
                {out: 'stove' ,in: [['iron_ingot', 24], ['coal', 12]]},
                {out: 'steam_gen' ,in: [['iron_ingot', 24]]},
                {out: 'farm' ,in: [['food', 12]]},
                {out: 'magnifier' ,in: [['iron_ingot', 6], ['coal', 3]]},
                {out: 'lightbulb' ,in: [['iron_ingot', 6], ['coal', 3]]},
                {out: 'led' ,in: [['iron_ingot', 6], ['coal', 3], ['lead_ingot', 2]]},
                {out: 'elec_furnace' ,in: [['iron_ingot', 24], ['coal', 12]]},
                {out: 'uran_furnace' ,in: [['iron_ingot', 24], ['coal', 12]]},
                {out: 'battery' ,in: [['coal', 24]]},
                {out: 'nuclear_reactor' ,in: [['iron_ingot', 96], ['coal', 96], ['uran_ingot', 4]]},
                {out: 'nuclear_antireactor' ,in: [['iron_ingot', 96], ['coal', 96], ['uran_ingot', 4]]},
                {out: 'anitimatter_gen' ,in: [['iron_ingot', 144], ['coal', 144], ['uran_ingot', 12]]},
                {out: 'anitimatter_reactor' ,in: [['iron_ingot', 144], ['coal', 144], ['uran_ingot', 12]]},
                {out: 'wormhole_gen' ,in: [['iron_ingot', 144], ['coal', 144], ['uran_ingot', 12], ['anti_iron_ingot', 12]]},
                {out: 'wormhole_reactor' ,in: [['iron_ingot', 144], ['coal', 144], ['uran_ingot', 12], ['anti_iron_ingot', 12]]},
                {out: 'coin_maker' ,in: [['iron_ingot', 12], ['coal', 12]]},
                {out: 'drill' ,in: [['iron_ingot', 24]]},
                {out: 'uran_drill' ,in: [['iron_ingot', 24]]},
                {out: 'antimatter_enricher' ,in: [['iron_ingot', 144], ['coal', 144], ['lead_ingot', 12], ['anti_iron_ingot', 4]]},
                {out: 'wormhole_enricher' ,in: [['iron_ingot', 144], ['coal', 144], ['lead_ingot', 12], ['wormhole', 4]]},
                // {out: 'store_food' ,in: [['iron_ingot', 6]]},
                // {out: 'store_coal' ,in: [['iron_ingot', 6]]},
                // {out: 'store_iron' ,in: [['iron_ingot', 6]]},
                {out: 'big_wormhole' ,in: [['wormhole', 24]]},
            ];
            let debug_crafting = global_debug;
            if (debug_crafting){
                crafting_layer = new YardLayer(8, 10);
                for (let [k, v] of entity_table){
                    crafting_recipes.push({
                        in: [],
                        out: k
                    });
                }
            }
            let crafting_recipes_positioned = new Map();

            let ground_crafting_region = {
                xa: 1, ya: 1, xb: 20, yb: 16
            }

            crafting_layer.layer_specific_info = function (inst){
                let i = inst.layer.xy2i(inst.x, inst.y);
                let recipe = crafting_recipes_positioned.get(i);
                if (!recipe){
                    return null;
                }
                let text = $('<div>');
                text.append('合成原料：');
                text.append('<br>');
                let still_need = can_craft(recipe.in);
                for (let [type_id, count] of recipe.in){
                    let type = item_table.get(type_id);
                    text.append($('<div>')
                        .css('background-image', `url('${type.icon}')`)
                        .css('background-size', '256px 256px')
                        .css('width', '100%').css('height', '100%')
                        .css('background-position', `-${type.pos_x * 16}px -${type.pos_y * 16}px`)
                        .css('width', '16px').css('height', '16px')
                        .addClass('cell-wrapper'));
                    text.append(`(${count - (still_need.get(type) || 0)}/${count}); `);
                }
                return text;
            }

            function get_default_state(entity_type){
                let state = {};
                for (let [state_key, values] of entity_type.enum_states()){
                    state[state_key] = values[0];
                }
                entity_type.init_other_states(state);
                return state;
            }

            function put_crafting(){
                let x = 0, y = 0;
                for (let recipe of crafting_recipes){
                    if (recipe.br){
                        y++;
                        continue;
                    }
                    crafting_recipes_positioned.set(crafting_layer.xy2i(x, y), recipe);
                    let out_type = entity_table.get(recipe.out);
                    crafting_layer.next_entity_sublayer.swap(x, y, out_type, get_default_state(out_type));
                    x++;
                    if (x >= crafting_layer.width){
                        y++;
                        x = 0;
                    }
                }
            }
            put_crafting();

            let total_crafted = new Map();

            function can_craft(in_list, do_craft=false){
                let need_count = new Map();
                for (let [item_key, item_amount] of in_list){
                    need_count.set(item_table.get(item_key), item_amount);
                }
                for (let y=ground_crafting_region.ya; y<ground_crafting_region.yb; y++){
                    for (let x=ground_crafting_region.xa; x<ground_crafting_region.xb; x++){
                        let inst = ground_layer.next_item_sublayer.get_inst(x, y);
                        let [recipe_type, recipe_amount] = inst.type.as_crafting_ingredient(inst);
                        if (need_count.has(recipe_type)){
                            if (do_craft){
                                ground_layer.next_item_sublayer.swap(x, y, item_table.get('empty'), null);
                                ground_layer.set_item_changed(x, y, true);
                            }
                            let prev_amount = need_count.get(recipe_type);
                            if (prev_amount - recipe_amount < 0){ // too many ingredients in one item
                                continue;
                            }
                            need_count.set(recipe_type, prev_amount - recipe_amount);
                            if (need_count.get(recipe_type) == 0){
                                need_count.delete(recipe_type);
                                if (need_count.size == 0){
                                    return need_count;
                                }
                            }
                        }
                    }
                }
                return need_count;
            }

            crafting_layer.on_mouse_place_entity = function(inst){
                let i = inst.layer.xy2i(inst.x, inst.y);
                let recipe = crafting_recipes_positioned.get(i);
                if (!hand_has_space()){
                    show_prompt('物品栏已满');
                    return {able: false};
                }
                if (can_craft(recipe.in).size == 0){
                    can_craft(recipe.in, true);
                    let out_type = entity_table.get(recipe.out);
                    let state = get_default_state(out_type);
                    for (let [k, v] of Object.entries(state)){
                        if (selected_states.has(k)){
                            state[k] = selected_states.get(k);
                        }
                    }
                    hand_autoinsert(out_type, state);
                    if (out_type === "big_wormhole"){
                        big_wormhole_crafted();
                    }
                    total_crafted.set(out_type.lookup_id, (total_crafted.get(out_type.lookup_id) || 0) + 1);
                    redraw_hand_and_selector();
                    show_prompt('+1');
                } else {
                    show_prompt('材料不足');
                }
                return {able: false};
            }

            let $crafting_cont = crafting_layer.make_cont(show_info, clear_and_show_hand);
            $('#crafting-cont').append($crafting_cont);
            crafting_layer.draw_all($crafting_cont);


            
            ground_layer.draw_all($layer_cont);
            let ikk = -1;
            $('body').append('<input type="text" id="spawn">');
            if (!global_debug){
                $('#spawn').hide();
            }
            $('#advance').on('click', (e)=>{
                ikk = setInterval(()=>{
                    $("#time").text(ground_layer.time);
                    let to_spawn = $('#spawn').val();
                    if (item_table.has(to_spawn)){
                        ground_layer.next_item_sublayer.swap(0, 0, item_table.get(to_spawn), null);
                    }
                    ground_layer.tick_all();
                    ground_layer.draw_all($layer_cont);
                    underground_layer.tick_all();
                    underground_layer.draw_all($underground_layer_cont);
                }, 50);
            });
            $('#advance').click();
            $('#stop').on('click', (e)=>{
                clearInterval(ikk);
            });


            $underground_layer_cont.hide();
            let ground_visible = true;
            function update_ground_visibility(){
                if (ground_visible){
                    $layer_cont.show();
                    $underground_layer_cont.hide();
                } else {
                    $layer_cont.hide();
                    $underground_layer_cont.show();
                }
            }

            $('#flip-yard').on('mouseenter', (e)=>{
                $layer_cont.show();
                $underground_layer_cont.show();
                $layer_cont.css('opacity', 0.5);
                $underground_layer_cont.css('opacity', 0.5);
            });

            $('#flip-yard').on('mouseleave', (e)=>{
                $layer_cont.css('opacity', '');
                $underground_layer_cont.css('opacity', '');
                update_ground_visibility();
            });

            $('#flip-yard').on('click', (e)=>{
                ground_visible = !ground_visible;
                update_ground_visibility();
            });

            function resize_map(width, height){
                
            }
            
            let is_map_small = true;
            $('#map-big-small').on('click', (e)=>{
                if (is_map_small){
                    resize_map(24, 16);
                } else {
                    resize_map(12, 8);
                }
                is_map_small = !is_map_small;
            });

            $('#yard-cont-inner .cell-wrapper').each((index, elem)=>{
                elem = $(elem);
                elem.data('ox', elem.data('x'));
                elem.data('oy', elem.data('y'));
            });

            let $map_background = $('<div>');
            $('#yard-cont-inner .ground-layer-cont').prepend($map_background);
            $map_background.css('background-image', 'url("floor_ground.png")');
            $map_background.css('background-size', '3264px 3264px');
            $map_background.css('width', '100%').css('height', '100%');
            $map_background.css('position', 'absolute');
            $map_background.css('opacity', '0.5');

            function restrict_yard_offset(){
                if (yard_offset_x < 0){
                    yard_offset_x = 0;
                } else if (yard_offset_x > (ground_layer.width - 24)){
                    yard_offset_x = ground_layer.width - 24;
                }
                if (yard_offset_y < 0){
                    yard_offset_y = 0;
                } else if (yard_offset_y > (ground_layer.height - 16)){
                    yard_offset_y = ground_layer.height - 16;
                }
            }


            function move_yard_update_tiles(){
                $('#yard-cont-inner .cell-wrapper').each((index, elem)=>{
                    elem = $(elem);
                    elem.data('x', elem.data('ox') + yard_offset_x);
                    elem.data('y', elem.data('oy') + yard_offset_y);
                    // ground_layer.draw_all($layer_cont);
                    // underground_layer.draw_all($underground_layer_cont);
                });
                $map_background.css('background-position', `-${yard_offset_x * 34}px -${yard_offset_y * 34}px`);
            }

            let $mouseclick_cont = $('.mouseclick-cont');

            let move_yard_timeout_id = null;

            $('.move-yard').on('mouseenter', (e)=>{
                // console.log('enter');
                clearTimeout(move_yard_timeout_id);
                let f = ()=>{
                    yard_offset_x += $(e.target).data('x');
                    yard_offset_y += $(e.target).data('y');
                    restrict_yard_offset();
                    move_yard_update_tiles();
                    move_yard_timeout_id = setTimeout(f, 100);
                };
                move_yard_timeout_id = setTimeout(f, 300);
            });
            
            $('.move-yard').on('mouseleave', (e)=>{
                // console.log('leave');
                clearTimeout(move_yard_timeout_id);
                move_yard_timeout_id = null;
            });

            // 放墙

            function ground_put_wall(x1, y1, x2, y2){
                for (let y=y1; y<=y2; y++){
                    for (let x=x1; x<=x2; x++){
                        ground_layer.next_entity_sublayer.swap(x, y, entity_table.get('wall'), null);
                    }
                }
            }

            // 左下小屋子
            ground_put_wall(1, 18, 1, 23);
            ground_put_wall(1, 18, 8, 18);
            ground_put_wall(8, 18, 8, 23);

            // 房屋外墙壁
            ground_put_wall(22, 0, 48, 0);
            ground_put_wall(22, 0, 22, 20);
            ground_put_wall(48, 0, 48, 20);
            ground_put_wall(22, 20, 42, 20);

            // 屋内墙
            ground_put_wall(23, 10, 24, 10);
            ground_put_wall(28, 10, 36, 10);
            ground_put_wall(40, 10, 42, 10);
            ground_put_wall(42, 10, 42, 16);
            ground_put_wall(42, 19, 42, 19);
            ground_put_wall(30, 11, 32, 11);
            ground_put_wall(23, 13, 25, 14);
            ground_put_wall(23, 16, 26, 17);
            ground_put_wall(27, 17, 31, 17);
            ground_put_wall(30, 15, 34, 16);
            ground_put_wall(30, 14, 31, 14);

            // 后院树石头
            ground_put_wall(35, 3, 36, 3);
            ground_put_wall(42, 5, 44, 8);
            ground_put_wall(41, 6, 41, 7);

            // 商店

            ground_layer.next_entity_sublayer.swap(2, 21, entity_table.get('store_food'), get_default_state(entity_table.get('store_food')));
            ground_layer.next_entity_sublayer.swap(4, 21, entity_table.get('store_coal'), get_default_state(entity_table.get('store_coal')));
            ground_layer.next_entity_sublayer.swap(6, 21, entity_table.get('store_iron'), get_default_state(entity_table.get('store_iron')));
            ground_layer.next_entity_sublayer.swap(42, 16, entity_table.get('elec_meter'), Object.assign(get_default_state(entity_table.get('elec_meter')), {dir: 1}));
            
            // 电动车充电器
            ground_layer.next_entity_sublayer.swap(21, 20, entity_table.get('coin_maker'), Object.assign(get_default_state(entity_table.get('coin_maker')), {dir: 3}));
            
            // 初始提供一些传送带
            for (let y=18; y<24; y++){
            for (let x=12; x<20; x++){
                ground_layer.next_entity_sublayer.swap(x, y, entity_table.get('belt'), Object.assign(get_default_state(entity_table.get('belt')), {dir: 1}));
            }
            }
            // 摆两条传送带
            for (let x=20; x<40; x++){
                ground_layer.next_entity_sublayer.swap(x, 23, entity_table.get('belt'), Object.assign(get_default_state(entity_table.get('belt')), {dir: 1}));
            }
            for (let x=20; x<40; x++){
                ground_layer.next_entity_sublayer.swap(x, 22, entity_table.get('belt'), Object.assign(get_default_state(entity_table.get('belt')), {dir: 2}));
            }

            // 后院提供火炉和蒸汽机
            ground_layer.next_entity_sublayer.swap(25, 3, entity_table.get('stove'), Object.assign(get_default_state(entity_table.get('stove')), {dir: 1}));
            ground_layer.next_entity_sublayer.swap(26, 5, entity_table.get('steam_gen'), Object.assign(get_default_state(entity_table.get('steam_gen')), {dir: 1}));

            // 车
            let $car_div = $('<div>');
            $car_div
                .css('width', '100%').css('height', '100%')
                .css('position', 'absolute')
                .css('background-image', 'url("car.png")')
                .css('background-size', '64px 64px')
                .css('background-repeat', 'no-repeat')
                .css('background-position', '-100px -100px');
            $('#yard-cont .ground-layer-cont>:first-child').after($car_div);

            let car_present = false;
            let car_x = 0;
            let car_y = 0;
            let car_speed = 0.3;

            function random_generate_coin(){
                let rx = Math.floor(Math.random() * (52)+0);
                let ry = Math.floor(Math.random() * (26-24)+24);
                if (
                    ground_layer.next_item_sublayer.get_inst(rx, ry).type === item_table.get('empty')
                ){
                    // 设置钱
                    ground_layer.next_item_sublayer.swap(rx, ry, item_table.get('coin'), null);
                }
            }
            // 初始先生成一些钱
            for (let i=0; i<20; i++){
                random_generate_coin();
            }
            
            let orig_tick_all = ground_layer.tick_all;
            ground_layer.tick_all = function() {
                // 太阳产生光线
                orig_tick_all.apply(this);
                if (Math.random() < 0.1){
                    let rx = Math.floor(Math.random() * (48-23)+23);
                    let ry = Math.floor(Math.random() * (10-1)+1);
                    if (
                        ground_layer.next_item_sublayer.get_inst(rx, ry).type === item_table.get('empty')
                    ){
                        // 设置光线
                        ground_layer.next_item_sublayer.swap(rx, ry, item_table.get('light'), null);
                    }
                }
                // 人行道产生钱币
                
                if (Math.random() < 0.001){
                    random_generate_coin();
                }
                
                if (car_x > 52){
                    car_present = false;
                    $car_div.css('background-position', `-100px -100px`);
                }
                if (car_present){
                    car_x += car_speed;
                    // 车撞坏建筑
                    if (Math.random() < 0.1){
                        if (ground_layer.next_item_sublayer.get_inst(Math.floor(car_x+1), Math.floor(car_y+1)).type !== item_table.get('empty')){
                            ground_layer.next_item_sublayer.swap(Math.floor(car_x+1), Math.floor(car_y+1), item_table.get('fire'), null);
                        }
                        if (ground_layer.next_entity_sublayer.get_inst(Math.floor(car_x+1), Math.floor(car_y+1)).type !== entity_table.get('empty')){
                            ground_layer.next_entity_sublayer.swap(Math.floor(car_x+1), Math.floor(car_y+1), entity_table.get('empty'), null);
                            ground_layer.next_item_sublayer.swap(Math.floor(car_x+1), Math.floor(car_y+1), item_table.get('fire'), null);
                        }
                    }
                    // render car
                    $car_div.css('background-position', `${-(yard_offset_x-car_x) * 34}px ${-(yard_offset_y-car_y) * 34}px`);
                } else {
                    if (Math.random() < 0.001){
                        car_present = true;
                        car_x = -3;
                        car_y = Math.random()*(33-2-26)+26;
                        $car_div.css('filter', `hue-rotate(${Math.random()*360}deg)`); // random color
                    }
                }
            }
        
        var typewriter={songData:[{i:[0,0,140,0,0,0,140,0,0,81,4,10,47,55,0,0,0,187,5,0,1,157,135,0,32,0,0,0,4],p:[1],c:[{n:[147],f:[]}]},{i:[0,0,128,0,0,0,128,0,0,125,21,1,25,49,0,0,0,0,0,0,1,193,171,0,29,39,3,0,0],p:[1],c:[{n:[,147],f:[]}]},],rowLen:5513,patternLen:32,endPattern:0,numChannels:2};
        function buildTypewriter() {
            return new Promise((resolve) => {
            // Initialize music generation (player).
            var t0 = new Date();
              var player = new CPlayer();
              player.init(typewriter);
            
              // Generate music...
              var done = false;
              let musicInterval = setInterval(function () {
                if (done) {
                    clearInterval(musicInterval);
                  return;
                }
            
                done = player.generate() >= 1;
            
                if (done) {
                  var t1 = new Date();
            
                  // Put the generated song in an Audio element.
                  var wave = player.createWave();
                  var audio = document.createElement("audio");
                  audio.src = URL.createObjectURL(new Blob([wave], {type: "audio/wav"}));
                  audio.volume = 0.2;
                  resolve(audio);
                }
              }, 0);
            });
              
        }
        buildTypewriter().then(audio => {
            window.typewriter_sound = audio;
        });

        function set_dialog_image(path){
            $('#dialog-image-cont').css('background-image', 'url("' + path + '")')
                .css('background-size', $('#dialog-image-cont').width(), $('#dialog-image-cont').height());
        }

        function set_multi_dialog_image(path, cx, cy){
            $('#dialog-image-cont').css('background-image', 'url("' + path + '")')
                .css('background-size', $('#dialog-image-cont').width() * 16, $('#dialog-image-cont').height() * 16)
                .css('background-position', `-${cx * $('#dialog-image-cont').width()}px -${cy * $('#dialog-image-cont').height()}px`);
        }
        
        
        let my_dialog_table = [
            [3, null],
            [8, '身为一个地球人，你所能看到的地球文化是多样的。——沃·兹基硕德'],
            [8, '202X年的国内，201X-ŋk0V病毒流行结束后，人们的生活都恢复了正轨。', ()=>set_multi_dialog_image('./dialog_image.png', 0, 0)],
            [8, ['我', '我是一名呼和浩特大学生，在城市里长大的我，其实并没有见过多少影视作品里面描写的草原情景。'], ()=>set_multi_dialog_image('./dialog_image.png', 1, 0)],
            [8, ['我', '说实话，这里和其他哪个城市差别也不是很大嘛。'], ()=>set_multi_dialog_image('./dialog_image.png', 2, 0)],
            [5, '...'],
            [8, ['我', '最近，学校里大家都在为研究生考试做准备。'], ()=>set_multi_dialog_image('./dialog_image.png', 3, 0)],
            [8, ['我', '但是我并没有继续上学的想法。'], ()=>set_multi_dialog_image('./dialog_image.png', 3, 0)],
            [8, ['我', '父亲经营着郊区的一家造纸厂，我准备毕业以后和父亲一起工作。'], ()=>set_multi_dialog_image('./dialog_image.png',4, 0)],
            [5, '...'],
            [8, ['我', '但是这些都不重要，实际上，这个暑假，我就要研究出我人生的「伟大之作」了。'], ()=>set_multi_dialog_image('./dialog_image.png', 5, 0)],
            [8, ['我', '202X年的科技，已经极为先进，人们完全可以过自己想要的生活。']],
            [8, ['我', '其他人只求安稳过日子，但我要用科技改变现在这种循规蹈矩的生活~！']],
            [5, '...'],
            [8, ['我', '我小的时候熟知的影视作品中，有一部是我最喜欢的，直到现在也是最喜欢的。']],
            [8, ['我', '这部作品的主角是六只幻想生物<ruby>䮒䮘<rt>pony</rt></ruby>，我将其称为「六色马」'], ()=>set_multi_dialog_image('./dialog_image.png', 6, 0)],
            [8, ['我', '结合当前我学习到的科学技术，我能通过巨大的能量扭曲空间，打开通往异世界的传送门。'], ()=>set_multi_dialog_image('./dialog_image.png', 7, 0)],
            [8, ['我', '这样，我就可以穿越到六色马的世界，摆脱人类世界的战争、饥荒、瘟疫，过上我想要的幸福生活。'], ()=>set_multi_dialog_image('./dialog_image.png', 8, 0)],
            [5, '...'],
            [8, ['我', '话不多说，我先着手开始工作吧，光说不做，传送门不会自己出现。'], ()=>set_multi_dialog_image('./dialog_image.png', 9, 0)],
            [8, ['我', '先从赚更多钱开始吧，这样就可以为稳定发电打下基础。'], ()=>set_multi_dialog_image('./dialog_image.png', 10, 0)],
            [8, ['我', '首先，我需要在<mark>商店</mark>买一些食物，并制造出大棚，使用后院的阳光生产出更多食物。']],
            [8, ['我', '有了食物，就可以雇用村民驱动抬升机发电，发出的电可以给邻居的电动车充电赚钱。']],
            [8, ['我', '先使用家旁边闲置的传送带运送物品吧。把路边的金币运送到店铺旁边，就会从棕色的三角处输出物品。']],
            [16, '目标：制作<mark>村民和抬升机</mark>', ()=>set_multi_dialog_image('./dialog_image.png', 1, 155)],
            [8, '因为是暑假期间，你的同学<u>李小慧</u>要到你家附近玩，你因为太关注自己的项目了，忘记了这回事。'],
            [3, '📱手机传来新消息📱', ()=>set_multi_dialog_image('./dialog_image.png', 0, 15)],
            [8, ['李小慧', '要去看电影吗，我们去你家旁边的「千达影城」看最近上映的「定居火星」，你要一起吗'], ()=>set_multi_dialog_image('./dialog_image.png', 1, 15)],
            [8, ['我', '...']],
            [8, ['我', '我还有事情要做，暑假要做项目，今天没有时间看，改天吧'], ()=>set_multi_dialog_image('./dialog_image.png', 2, 15)],
            [8, ['李小慧', '那下午要一起去玩「剧本杀」吗']],
            [8, ['我', '下午也没有时间']],
            [8, ['李小慧', '晚上去唱ktv吧，你的项目应该没有这么着急吧，暑假这么长时间，放松一下也来得及嘛'], ()=>set_multi_dialog_image('./dialog_image.png', 3, 15)],
            [8, ['我', '不好意思，这实在是一个大项目，必须要付出很多精力，所以今天我还是不出去了'], ()=>set_multi_dialog_image('./dialog_image.png', 4, 15)],
            [4, '李小慧说的其实有道理，我已经掌握了必须的知识，迟早能做出来的。但是我也不喜欢去剧本杀或者ktv', ()=>set_multi_dialog_image('./dialog_image.png', 3, 15)],
            [4, '尤其是ktv，我感觉很多人花钱到一个小房子里唱歌，这简直太荒唐了'],
            [4, '人类和其他个体交流的话，很少时候传递有效的信息，大部分的社会交流活动都比不上我现在致力做的传送门', ()=>set_multi_dialog_image('./dialog_image.png', 4, 15)],
            [16, '目标：制作<mark>村民和抬升机</mark>', ()=>set_multi_dialog_image('./dialog_image.png', 15, 15)],
            [1, '目标完成', null, ()=>{
                if (total_crafted.get('villager') >= 1 && total_crafted.get('gravity_gen') >= 1){
                    return true;
                }
                return false;
            }],
            [8, ['我', '让村民抬起抬升机发电，这种办法可以用，但是发出的电都散失了。'], ()=>set_multi_dialog_image('./dialog_image.png', 0, 1)],
            [8, ['我', '应该想出一个存储电能的方法，比如使用电炉烧铁矿，或者用灯变成热量，另作他用。']],
            [8, ['我', '说起来，现在我的矿还都是商店买的，应该用钻头自己挖矿，这样既能储存能量，又能让矿物生产自给自足。'], ()=>set_multi_dialog_image('./dialog_image.png', 1, 1)],
            [8, '目标：制作<mark>挖矿机和电炉</mark>'],
            [8, ['父亲', '放假整天待在家里面，你看你其他同学都发自己出去哪玩了，参加什么活动了，你怎么什么地方都不去呢'], ()=>set_multi_dialog_image('./dialog_image.png', 2, 1)],
            [8, ['我', '我不喜欢出去玩，景色再好看也只是物质，对科学技术的追求才是我想要的'], ()=>set_multi_dialog_image('./dialog_image.png', 3, 1)],
            [8, '比起外面的景色来说，我心中的那片世外桃源，才是我最希望达到的。在六色马面前，什么奇观异景就像是小孩子过家家的游戏'],
            [8, '目标：制作<mark>挖矿机和电炉</mark>'],
            [1, '目标完成', null, ()=>{
                if (total_crafted.get('drill') >= 1 && total_crafted.get('elec_furnace') >= 1){
                    return true;
                }
                return false;
            }],
            [8, ['我', '必须要用更高级的物品增加电力生产的效率，这样才能达到最终传送门需要的能量。']],
            [8, ['我', '接下来的领域，课本上也学习不到，如何利用可逆核过程解放出核子中的能量'], ()=>set_multi_dialog_image('./dialog_image.png', 0, 2)],
            [8, ['我', '这已经是一种艺术了，是普通人无法企及的领域']],
            [3, '📱手机传来新消息📱', ()=>set_multi_dialog_image('./dialog_image.png', 0, 15)],
            [8, ['李小慧', '我们今天邀了朋友认识的学妹，她好像对你很有好感呀，我们今天要去电玩店玩主机游戏，你们可以顺势就在一起玩'], ()=>set_multi_dialog_image('./dialog_image.png', 1, 2)],
            [8, ['李小慧', '多好的机会呀，这不比你那个什么科学研究好']],
            [8, ['我', '你们好好玩吧，我手头的工作还有很多要解决的问题，暂时没法去'], ()=>set_multi_dialog_image('./dialog_image.png', 0, 2)],
            [8, ['李小慧', '行吧，就是怎么每次叫你都不去，你再这样下去到时候没有人想和你交朋友了'], ()=>set_multi_dialog_image('./dialog_image.png', 0, 2)],
            [8, '李小慧居然这样说我，其实我根本不喜欢他们那些社交活动，根本就是小打小闹。我还是加紧制作需要的核反应堆吧', ()=>set_multi_dialog_image('./dialog_image.png', 4, 15)],
            
            [8, '目标：制作<mark>核反应堆</mark>'],
            [1, '目标完成', null, ()=>{
                if (total_crafted.get('nuclear_reactor') >= 1){
                    return true;
                }
                return false;
            }],
            [8, ['我', '马上就要开学了，但是我不能去学校，我要隐藏起来将「伟大之作」完成'], ()=>set_multi_dialog_image('./dialog_image.png', 0, 3)],
            [8, ['我', '驾驭反物质的力量，最终制造出通往异世界的虫洞！'], ()=>set_multi_dialog_image('./dialog_image.png', 1, 3)],
            [8, ['我', '学校，事业，金钱已经不是我所关心的事情'], ()=>set_multi_dialog_image('./dialog_image.png', 2, 3)],
            [8, ['我', '六色马就是我唯一的目标'], ()=>set_multi_dialog_image('./dialog_image.png', 3, 3)],
            [8, ['我', '现在，食物，饮水我已经能够自给自足'], ()=>set_multi_dialog_image('./dialog_image.png', 0, 3)],
            [8, ['我', '目标已经掌握'], ()=>set_multi_dialog_image('./dialog_image.png', 0, 3)],
            [8, ['我', '剩下的只有劳动和工作！'], ()=>set_multi_dialog_image('./dialog_image.png', 0, 3)],
            [3, '📱手机传来新消息📱', ()=>set_multi_dialog_image('./dialog_image.png', 0, 15)],
            [8, ['我', '手机就扔掉吧，现在已经没有任何用处了！'], ()=>set_multi_dialog_image('./dialog_image.png', 2, 3)],
            [8, '目标：制作<mark>时空界面</mark>'],
            [1, '目标完成', null, ()=>{
                if (total_crafted.get('wormhole_gen') >= 1){
                    return true;
                }
                return false;
            }],
            [8, ['我', '马上就能产出微虫洞了，但是还需要将许多微虫洞合到一起，才能容许我通过'], ()=>set_multi_dialog_image('./dialog_image.png', 1, 3)],
            [8, ['我', '我哭，我心心念念的六色马呀！还有多长时间，我可以见到你们？'], ()=>set_multi_dialog_image('./dialog_image.png', 3, 3)],
            [8, ['我', '继续努力吧，少说话多做事'], ()=>set_multi_dialog_image('./dialog_image.png', 0, 3)],
            [8, '目标：制作<mark>虫洞</mark>'],
            [1, '目标完成', null, ()=>{
                if (total_crafted.get('big_wormhole') >= 1){
                    return true;
                }
                return false;
            }],
            [3, '你做出了虫洞。'],
            [3, '就这样，你走上了人生巅峰，走进了人生的高潮。'],
        ];
        let current_dialog_i = 0;
        let my_dialog_timeout = -1;
        
        window.dialog_timeout_id = -1;
        window.remaining_text = "";
        window.dialog_html = "<br><br><br><br><br><br><br><br><br><br><br><br>";

        let has_dialog = false;
        $('body').on('click', ()=>{
            if (!has_dialog){
                my_dialog_f(0);
                has_dialog = true;
            }
        });
        
        function get_save(){
            let save_data = {};
            save_data.layer = [];
            for (let layer of [ground_layer, underground_layer, hand_layer]){
                save_data.layer.push(layer.next_item_sublayer.type.map(it => it.lookup_id));
                save_data.layer.push(Object.fromEntries(layer.next_item_sublayer.state));
                save_data.layer.push(layer.next_entity_sublayer.type.map(it => it.lookup_id));
                save_data.layer.push(Object.fromEntries(layer.next_entity_sublayer.state));
            }
            save_data.total_produced = Object.fromEntries(total_produced);
            save_data.total_crafted = Object.fromEntries(total_crafted);
            save_data.time = ground_layer.time;
            save_data.view = [yard_offset_x, yard_offset_y];
            save_data.car = {
                car_present: car_present,
                car_speed: car_speed,
                car_x: car_x,
                car_y: car_y
            };
            save_data.current_dialog_i = current_dialog_i;
            return save_data;
        }
        
        function set_save(save_data){
            let c = 0;
            for (let layer of [ground_layer, underground_layer, hand_layer]){
                layer.next_item_sublayer.type = save_data.layer[c].map(it => item_table.get(it));
                c++;
                layer.next_item_sublayer.state = new Map(Object.entries(save_data.layer[c]).map(p => [parseInt(p[0]), p[1]]));
                c++;
                layer.next_entity_sublayer.type = save_data.layer[c].map(it => entity_table.get(it));
                c++;
                layer.next_entity_sublayer.state = new Map(Object.entries(save_data.layer[c]).map(p => [parseInt(p[0]), p[1]]));
                c++;
            }
            total_produced = new Map(Object.entries(save_data.total_produced));
            total_crafted = new Map(Object.entries(save_data.total_crafted));
            ground_layer.time = underground_layer.time = save_data.time;
            [yard_offset_x, yard_offset_y] = save_data.view;
            ({
                car_present,
                car_speed,
                car_x,
                car_y
            } = save_data.car);
            current_dialog_i = save_data.current_dialog_i;
            move_yard_update_tiles();
            redraw_hand_and_selector();
            reset_my_dialog(current_dialog_i);
        }
        
        $('#save').on('click', (e)=>{
            try{
                localStorage.setItem('ponylover_save', JSON.stringify(get_save()));
                show_prompt('保存成功');
                show_dialog('保存成功');
            } catch (e){
                show_prompt(`保存失败，${e}`);
            }
        });
        
        $('#clear-save').on('click', (e)=>{
            try{
                localStorage.removeItem('ponylover_save');
                show_prompt('重置成功，请刷新');
            } catch (e){
                show_prompt(`重置失败，${e}`);
            }
        });
        
        yard_offset_x = 28;
        yard_offset_y = 10;
        move_yard_update_tiles();
        
        let k;
        setTimeout(()=>{
            if (k = JSON.parse(localStorage.getItem('ponylover_save'))){
                show_dialog('读取存档');
                set_save(k);
            } else {
                show_dialog('没有存档');
            }
        }, 0);
        
        $('body').on('keydown', (e) => {
            if (e.key === 'a' || e.key === 'ArrowLeft'){
                yard_offset_x -= 3;
                restrict_yard_offset();
                move_yard_update_tiles();
            }
            if (e.key === 'd' || e.key === 'ArrowRight'){
                yard_offset_x += 3;
                restrict_yard_offset();
                move_yard_update_tiles();
            }
            if (e.key === 'w' || e.key === 'ArrowUp'){
                yard_offset_y -= 3;
                restrict_yard_offset();
                move_yard_update_tiles();
            }
            if (e.key === 's' || e.key === 'ArrowDown'){
                yard_offset_y += 3;
                restrict_yard_offset();
                move_yard_update_tiles();
            }
            if (e.key === '1'){$('#hand-cont .mouseclick-cont .cell-wrapper')[1].click();}
            if (e.key === '2'){$('#hand-cont .mouseclick-cont .cell-wrapper')[2].click();}
            if (e.key === '3'){$('#hand-cont .mouseclick-cont .cell-wrapper')[3].click();}
            if (e.key === '4'){$('#hand-cont .mouseclick-cont .cell-wrapper')[4].click();}
            if (e.key === '5'){$('#hand-cont .mouseclick-cont .cell-wrapper')[5].click();}
            if (e.key === 'i'){
                $('#op-cont .mouseclick-cont .cell-wrapper')[0].click();
            }
            if (e.key === 'j'){
                $('#op-cont .mouseclick-cont .cell-wrapper')[1].click();
            }
            if (e.key === 'l'){
                $('#op-cont .mouseclick-cont .cell-wrapper')[2].click();
            }
            if (e.key === 'k'){
                $('#op-cont .mouseclick-cont .cell-wrapper')[3].click();
            }
            if (e.key === ',' || e.key ==='.'){
                $('#flip-yard').click();
            }
        });

        let has_music = false;
        $('body').on('click', e=>{
            if (!has_music){
                startMusic();
                has_music = true;
            }
        });

        $('#turn-music').on('click', e=>{
            if (window.bgm){
                if (!window.bgm.paused){
                    window.bgm.pause();
                    show_prompt('已关闭');
                } else {
                    window.bgm.play();
                    show_prompt('已开启');
                }
            }
        });

        function dialog_timeout_f(){
            if (remaining_text.length <= 0){
                window.dialog_timeout_id = -1;
                return;
            }
            let ch = remaining_text.substring(0, 2);
            window.remaining_text = remaining_text.substring(2);
            window.dialog_html += ch;
            $('#dialog-cont').html(window.dialog_html);
            $('#dialog-cont')[0].scrollTop = $('#dialog-cont')[0].scrollHeight;
            if (window.typewriter_sound){
                window.typewriter_sound.playbackspeed = 0.9 + Math.random() * 0.2;
                window.typewriter_sound.currentTime = 0;
                window.typewriter_sound.play().catch((e) => {});
            }
            window.dialog_timeout_id = setTimeout(dialog_timeout_f, 50);
        }

        function show_dialog(role, text){

            let old = window.dialog_html;
            window.dialog_html = old.split('<br>').slice(1).join('<br>') + window.remaining_text;
            window.remaining_text = "";
            $('#dialog-cont').html(window.dialog_html);
            $('#dialog-cont')[0].scrollTop = $('#dialog-cont')[0].scrollHeight;
            clearTimeout(window.dialog_timeout_id);
            if (!text){
                window.remaining_text += '<br>' + role;
            } else {
                window.remaining_text += '<br>' + '<span class="dialog-role">[' + role + ']</span>' + text;
            }
            window.dialog_timeout_id = setTimeout(dialog_timeout_f, 0);
        }

        show_dialog('运行成功了，你非常幸运');

        function reset_my_dialog(i){
            has_dialog = true;
            clearTimeout(my_dialog_timeout);
            // clearTimeout(current_dialog_i);
            my_dialog_timeout = -1;
            let k = false;
            $('body').on('click', ()=>{
                if (!k){
                    if (my_dialog_table[i][3]){
                        my_dialog_f(i-1);
                    } else {
                        my_dialog_f(i);
                    }
                    k = true;
                }
            });
        }

        function quick_my_dialog(){
            clearTimeout(my_dialog_timeout);
            my_dialog_f(current_dialog_i, true);
        }

        $('#skip-dialog').on('click', quick_my_dialog);

        function my_dialog_f(i, instant=false){
            current_dialog_i = i;
            if (i >= my_dialog_table.length){
                return;
            }
            let dialog_record = my_dialog_table[i];
            let [time, text, func, condition] = dialog_record;
            if (func){
                func();
            }
            if (condition && !condition()){
                my_dialog_timeout = setTimeout(()=>my_dialog_f(i), instant ? 10 : time * 1000);
            } else {
                if (!instant){
                    if (text && text instanceof Array){
                        show_dialog(text[0], text[1]);
                    } else if (text){
                        show_dialog(text);
                    }
                }
                my_dialog_timeout = setTimeout(()=>my_dialog_f(i+1), instant ? 10 : time * 1000);
            }
        }

        function make_stats(){
            let h = "<table><tbody>";
            let i = 0;
            for (let [type_id, type] of item_table){
                if (i % 5 == 0){
                    h += '<tr>';
                }
                h += '<td>';
                let asd =item_table.get(type_id).draw({});
                if (asd){
                    let k = $('<div>').append(asd);
                    let type_icon = k.html();
                    h += type_icon;
                }
                h += '</td>';
                h += '<td>' + (total_produced.get(type_id) || 0 )+ '<span class="space"></span></td>';
                if (h % 5 == 4){
                    h += '</tr>';
                }
                i++;
            }
            h += '</tbody></table>';
            return h;
        }

        function make_entity_stats(){
            let h = "<table><tbody>";
            let i = 0;
            for (let [type_id, type] of entity_table){
                if (i % 5 == 0){
                    h += '<tr>';
                }
                h += '<td>';
                let asd =entity_table.get(type_id).draw({type: type, state: get_default_state(type)});
                if (asd){
                    let k = $('<div>').append(asd.css('width', '32px').css('height', '32px'));
                    let type_icon = k.html();
                    h += type_icon;
                } else {
                    h += type_id;
                }
                h += '</td>';
                h += '<td>' + (total_crafted.get(type_id) || 0 )+ '<span class="space"></span></td>';
                if (h % 5 == 4){
                    h += '</tr>';
                }
                i++;
            }
            h += '</tbody></table>';
            return h;
        }

        function big_wormhole_crafted(quick=false){
            // $('body').css('background', 'radial-gradient(ellipse at center,  #1e5799 0%,#7db9e8 100%)');
            $('body').addClass('hue-rotate-animated');
            if (window.bgm){
                window.bgm.pause();
            }
            clearInterval(ikk);
            setTimeout(() => {
                $('#game-cont').hide();
                setTimeout(() => {
                    $('body').removeClass('hue-rotate-animated');
                    $('#complete-cont').show();
                    $('#stats-cont').html(make_stats());
                    $('#entity-stats-cont').html(make_entity_stats());
                    let wormhole_count = total_produced.get('wormhole') || 0;
                    let antimatter_count = total_produced.get('anti_iron_ingot') || 0;
                    let decision = wormhole_count * 5 + antimatter_count;
                    $('#six-color').attr('src', './pony'+decision+'.png');
                    $('#six-color-color').css('background-color', [
                        '#CC9CDF',
                        '#9BDBF5',
                        '#FAF5AB',
                        '#F5B7D0',
                        '#FABA62',
                        '#EAEEF0'
                    ][decision]);
                    $('#six-color-text').text([
                        'Purple Smart',
                        'Blue Fast',
                        'Flustershy',
                        'Ponka Pone',
                        'Applesack',
                        'Charity'
                    ][decision]);

                }, quick ? 0 : 3000);
            }, quick ? 0 : 3000);
        }

        </script>
        <script>
            /*
            剧情：一个人特别爱六只马(pony)，这是他家的电表发生的变化……
                为了穿越到六马的世界，他读了很多书，发现要扭曲空间，需要很多能量。因此他开始搭建生产线，产出能量。
            类factorio：
                资源：
                    - 固态：粮食、饭、煤、铁矿、铀矿
                        铁、铀、铅
                        反铁
                    - 气态：
                        微虫洞
                        火、光、电
                机器：
                    - 物流
                        - （6铁/12铁6煤/24铁1铅）传送带（运送物品）
                        - （24铁）传送梯（跨层传送带）
                        - （12铁）路由器（随机分物品）
                        - （12铁）分类器（按类别分物品）
                        每种传送带有三阶，快中慢，快是1刻，中是3刻，慢是5刻。
                    - 能量转化
                        - 势能电池（50%效率）：抬升机放6电转化成基态（可以手动消耗饭激发）；村民消耗1饭，将旁边（4邻居）的抬升机激发1个(冷却时间约5s)
                        - 热能电池（37.5%效率）：炉子将1煤转化成9火，蒸汽机将2火转化成1电；大棚将12光转化成1粮食，1粮食在炉子转化成1饭，1饭在炉子转化成1煤
                        - 太阳能电池：放大镜把2光转化成1火；白炽灯把3电转化成期望值1光和2火，- LED灯把1电转化成1光
                        - 化学电池（83%效率）：电炉（消耗24电把1铁矿变24铁）+ 原电池（把24铁变1铁矿，产生20电）
                        - 可逆核过程电池（86%效率）：核反应堆把1铀变1铅，放144火，核子置入器把1铅变1铀，吸168火
                        - 反物质电池：光子对撞机吸144*4光和144*4火产生1铁和1反铁，两者在约束反应器中产生144*4光和136*4电
                        - 虫洞电池：时空界面消耗1728电和1728光产生微虫洞，微虫洞在反时空界面分解产生1728电和1680火

                    - 电动车充电（消耗6电，产生1圆钱，冷却6s）
                    - 钻头（挖矿）取决于位置，挖出铁矿、煤（1次挖24个）或1铀。消耗6电挖一格。铀是消耗6电和12铁
                    - 电炉（冶炼矿物）消耗24电把1铁矿变24铁，离心机消耗24电把1铀矿变3铀
                    - 反物质增殖装置：24反铁和6铅，75%概率变25反铁，25%概率变24反铁
                    - 宇宙际强力浓差虫洞增殖装置：12微虫洞和3反铁，75%概率变13微虫洞，25%概率变12微虫洞
                固定设施：
                    - 商店（购买饭（2圆），煤（3圆）、铁（3圆））
                    - 插座、电表：把钱输入电表，插座就可以出电（冷却时间长，1s出1电，1圆钱出12电）
                    - 太阳（产生光，1s随机地点产生12个光）
                世界场景：自己的家里面、院子（可以自由放东西的地图，有2层）/邻居、商店（只是可以交互的场景）/手（一格空间可以存物品）
                剧情邻居人物：赵犰狳、钱蝙蝠、孙骆驼、李蜻蜓、...

                短期TODO:
                    - [x] 鼠标指到物品上会隐藏
                    - [x] 动态实体描述
                    - [x] 合成器、钻头等等实体的状态贴图或进度条
                    - 日夜循环，白天没太阳
                    - [x] 只有下层能挖矿
                    - [x] 商店不能动
                    - [x]电表插座
                    - [x]背景图
                    - [x]移动视角
                    - 放大缩小画面
                    - [x] 扩大物品栏面积
                    - [x]键盘快捷键
                    - [x]保存读取
                    - 音乐
                        - https://sb.bitsnbites.eu/?data=U0JveA4C7dxPSsNAFMfxXyYpRRF1K7jIDbpR3CgeQQTX0gMouHAjLgyilpZQ-8c_RfAabjyUR6jvtamWohsX0uj3M7y-yUwDM8lyeHlZl1aUJvEwkzy0rZM1jYTluqreiWY0xvPqFrld5FaRm0XOi9wp8vXM_-9n8mQcAAAAAAAAAAAA-E1hN1O8mS1I1crGZGwopbVYikIUYmuJNe8PbPLcom9xavGgWw3U1ZP1H0uwWT_s84M5P8w7HuWWmvbr--mUYP3PFpmFv4ezEj7_TFe60eXo-Zdx_QAAAAAAAAAA4C_Kx7GfLNa2rPtaUfTWUHpUWU182ivKgpE8PqvAvsvzrD0VX10DAAAAAAAAAADgfxl_hjGXLkKo7dhAPY7iwz2lB2EpUWzNRNa8xMwrs_pTN_s52-SgqQyVWW31dDdVw5TbqnsfH4Ocf7Pr7du17wkAAAAAAAAAAAA_8w4
                    - 剧情

                DLC或更新：
                - 钻头效应变化
                    - 在同一格挖的时间越长，挖的时间越慢，消耗能量越多，收益越好，但总体是更不值的。
                - 买地
                    - 买邻居家的院子、地。实现为多个Layer实例组（需要封装），院子间只能传输物品不能传输能量。（暂时不可能实现）
                - 蒸汽机温度
                    - 加入火升温，随时间降温，升温时转化效率高。
                - 压缩与解压
                    - 打包机把6个（相同）资源压成包裹，装载机把6个包裹装成集装箱，卸载机和解包机相反
                    - 不能处理气态物体
                - 升压/降压器
                    - 将6个普通电变成中压电，将6个中压电变成高压电
                - 机械齿轮组
                    - 将6个普通功变成中力功，将6个中力功变成大力功
                - 重量传送带
                    - 每个物品的重量是1，打包后重量变重，机器打包时将包好的物品输出到前方，可以根据重量决定运走或者不走
                - 显卡（消耗电，产生算力）
                - 手机（消耗电，产生网络数据包）
                - 加密货币钱包（消耗算力和网络数据包，产生金钱）
                - 银行（兑换钱的面额）
                - 研究科技，计算机消耗算力还有网络数据包（还有材料？），可以研究科技，刚开始不用计算机，是拿煤做书读书
                - 水、重水、聚变发电机
                - 资源
                    炎、焱
                    废料（辣鸡）
                    智子
                    功
                - 机械能/齿轮放大做的功

            写得很烂能乱玩就可以了，千万不要尝试抽象，写什么类
            */
        </script>
    </body>
</html>
